{% extends "sync/base.html" %}
{% load static %}

{% block title %}Detalhes da Empresa - {{ empresa.razao_emp|default:'Empresa' }}{% endblock %}

{% block page_title %}Detalhes da Empresa{% endblock %}
{% block page_subtitle %}{{ empresa.cgce_emp|default:'CNPJ não disponível' }}{% endblock %}

{% block content %}
<div class="admin-card space-y-6" x-data="empresaDetalhesPage({{ empresa.codi_emp|default:'null' }}, {{ empresa.habilitada_sincronizacao|yesno:'true,false,false' }}, '{{ empresa.cgce_emp|default:"" }}')">

    <!-- Botão Voltar e Título da Seção -->
    <div class="flex justify-between items-center mb-6">
        <div class="flex-1">
            <!-- O título principal da página já está no block page_title -->
            <!-- O subtítulo com CNPJ está no block page_subtitle -->
        </div>
        <a href="{% url 'sync_empresas_list' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-3 rounded-lg shadow-sm flex items-center whitespace-nowrap">
            <i data-feather="arrow-left" class="w-4 h-4 mr-2"></i>Voltar para Lista
        </a>
    </div>

    <!-- Informações da Empresa e Botão de Sincronização -->
    <div class="bg-white p-6 rounded-lg shadow border border-gray-200 space-y-4">
        <div class="flex justify-between items-start">
            <div>
                <h2 class="text-xl font-semibold text-gray-700">{{ empresa.razao_emp|default:'Nome não disponível' }}</h2>
                <p class="text-sm text-gray-500">CNPJ: {{ empresa.cgce_emp|default:'Não informado' }}</p>
            </div>
            <button @click="toggleSincronizacaoDetalhes()"
                    :class="{
                        'bg-green-600 hover:bg-green-700 text-white': habilitada,
                        'bg-red-600 hover:bg-red-700 text-white': !habilitada
                    }"
                    class="font-medium py-2 px-4 rounded-md shadow-sm whitespace-nowrap flex items-center">
                <i :data-feather="habilitada ? 'check-circle' : 'slash'" class="w-4 h-4 mr-2"></i>
                <span x-text="habilitada ? 'Sincronização Ativa' : 'Sincronização Inativa'"></span>
                <span x-show="isLoadingToggle" class="ml-2"><i data-feather="loader" class="animate-spin w-4 h-4"></i></span>
            </button>
        </div>

        <!-- Cards de Detalhes -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 pt-4">
            <div class="admin-info-card">
                <h3 class="text-sm font-medium text-gray-500">Código</h3>
                <p class="text-lg font-semibold text-gray-800">{{ empresa.codi_emp|default:'N/A' }}</p>
            </div>
            <div class="admin-info-card">
                <h3 class="text-sm font-medium text-gray-500">Razão Social</h3>
                <p class="text-lg font-semibold text-gray-800">{{ empresa.razao_emp|default:'N/A' }}</p>
            </div>
            <div class="admin-info-card">
                <h3 class="text-sm font-medium text-gray-500">CNPJ</h3>
                <p class="text-lg font-semibold text-gray-800">{{ empresa.cgce_emp|default:'N/A' }}</p>
            </div>
            <div class="admin-info-card border-l-4 w-max"
                 :class="{
                     'border-green-500': habilitada, 
                     'border-red-500': !habilitada,
                     'bg-green-50': habilitada,  // Adicionando um leve fundo verde
                     'bg-red-50': !habilitada    // Adicionando um leve fundo vermelho
                 }">
                <h3 class="text-sm font-medium text-gray-500">Status Sincronização</h3>
                <span :class="{'admin-badge-success': habilitada, 'admin-badge-danger': !habilitada}" class="px-3 py-1 rounded-full text-sm font-medium">
                    <span x-text="habilitada ? 'Ativa' : 'Inativa'"></span>
                </span>
            </div>
        </div>
    </div>

    <!-- Container para mensagens de notificação -->
    <div id="message-container-detalhes" class="fixed top-5 right-5 z-50 space-y-2"></div>

    {# --- Início da Seção de Fornecedores --- #}
    <div class="mt-8 pt-6 border-t border-gray-200">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold text-gray-700">Fornecedores da Empresa</h2>
            <span>aqui</span>
            <button @click="iniciarSincronizacaoEmLote()"
                    class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-md shadow-sm flex items-center whitespace-nowrap"
                    title="Iniciar a sincronização em lote para fornecedores pendentes (status Não Sincronizado ou Erro) que possuem CNPJ.">
                <i data-feather="zap" class="w-4 h-4 mr-2"></i>
                Sincronizar Pendentes em Lote
                <span x-show="isLoadingLote" class="ml-2"><i data-feather="loader" class="animate-spin w-4 h-4"></i></span>
            </button>
        </div>

        {# Formulário de Filtros para Fornecedores #}
        <form method="GET" action="" class="mb-6 p-4 bg-gray-50 rounded-lg shadow">
            {% csrf_token %} {# Embora GET, útil para consistência ou futuras mudanças #}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="f_codi_for" class="block text-sm font-medium text-gray-700 mb-1">Cód. Fornecedor</label>
                    <input type="text" name="f_codi_for" id="f_codi_for" value="{{ current_f_codi_for|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm disabled:opacity-50 disabled:bg-gray-50">
                </div>
                <div>
                    <label for="f_nome_for" class="block text-sm font-medium text-gray-700 mb-1">Nome do Fornecedor</label>
                    <input type="text" name="f_nome_for" id="f_nome_for" value="{{ current_f_nome_for|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm disabled:opacity-50 disabled:bg-gray-50">
                </div>
                <div>
                    <label for="f_cgce_for" class="block text-sm font-medium text-gray-700 mb-1">CNPJ/CGC Fornecedor</label>
                    <input type="text" name="f_cgce_for" id="f_cgce_for" value="{{ current_f_cgce_for|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm disabled:opacity-50 disabled:bg-gray-50">
                </div>
                <div>
                    <label for="f_status_sinc" class="block text-sm font-medium text-gray-700 mb-1">Status Sincronização</label>
                    <select name="f_status_sinc" id="f_status_sinc" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm disabled:opacity-50 disabled:bg-gray-50">
                        <option value="todos" {% if current_f_status_sinc == 'todos' or not current_f_status_sinc %}selected{% endif %}>Todos</option>
                        <option value="NAO_SINCRONIZADO" {% if current_f_status_sinc == 'NAO_SINCRONIZADO' %}selected{% endif %}>Não Sincronizado</option>
                        <option value="SINCRONIZADO" {% if current_f_status_sinc == 'SINCRONIZADO' %}selected{% endif %}>Sincronizado</option>
                        <option value="ERRO" {% if current_f_status_sinc == 'ERRO' %}selected{% endif %}>Com Erro</option>
                    </select>
                </div>
                <div class="lg:col-span-4 flex space-x-2 justify-end">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm flex items-center w-full md:w-auto">
                        <i data-feather="filter" class="w-4 h-4 mr-2"></i>Filtrar
                    </button>
                    <a href="{% url 'sync_empresa_detalhes' codi_emp=empresa.codi_emp %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md shadow-sm flex items-center w-full md:w-auto">
                        <i data-feather="rotate-ccw" class="w-4 h-4 mr-2"></i>Limpar
                    </a>
                </div>
            </div>
        </form>

        {# Tabela de Fornecedores #}
        {% if fornecedores_list %}
            <div class="overflow-x-auto admin-table-container rounded-lg shadow border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Cód. Forn.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Nome</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">CNPJ/CGC</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Cód. Conta</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Status Sinc.</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 bg-white">
                        {% for fornecedor in fornecedores_list %}
                            <tr id="fornecedor-row-{{ fornecedor.codi_for }}">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ fornecedor.codi_for }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ fornecedor.nome_for }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ fornecedor.cgce_for|default:'-' }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ fornecedor.codi_cta|default:'-' }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                          :class="{
                                            'bg-green-100 text-green-800': '{{ fornecedor.status_sincronizacao_raw }}' === 'SINCRONIZADO',
                                            'bg-red-100 text-red-800': '{{ fornecedor.status_sincronizacao_raw }}' === 'ERRO',
                                            'bg-gray-100 text-gray-800': '{{ fornecedor.status_sincronizacao_raw }}' !== 'SINCRONIZADO' && '{{ fornecedor.status_sincronizacao_raw }}' !== 'ERRO'
                                          }">
                                        {{ fornecedor.status_sincronizacao|default:'Não Sincronizado' }}
                                    </span>
                                    {% if fornecedor.ultima_tentativa_sinc %}
                                        <p class="text-xs text-gray-500 mt-1" title="Última tentativa de sincronização">
                                            {{ fornecedor.ultima_tentativa_sinc|date:"d/m/y H:i" }}
                                        </p>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button @click="chamarSincronizacaoFornecedor($event)"
                                            data-codi-for="{{ fornecedor.codi_for }}"
                                            data-nome-for="{{ fornecedor.nome_for|escapejs }}"
                                            data-cgce-for="{{ fornecedor.cgce_for|default:'' }}"
                                            data-codi-cta="{{ fornecedor.codi_cta|default:'' }}"
                                            class="text-sm flex items-center justify-center px-3 py-1.5 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 font-semibold disabled:opacity-60 disabled:cursor-not-allowed transition-colors duration-200 {% if fornecedor.status_sincronizacao_raw == 'SINCRONIZADO' %}bg-green-600 hover:bg-green-700 text-white{% elif fornecedor.status_sincronizacao_raw == 'ERRO' %}bg-yellow-500 hover:bg-yellow-600 text-white{% else %}bg-indigo-600 hover:bg-indigo-700 text-white{% endif %}"
                                            title="{% if fornecedor.status_sincronizacao_raw == 'SINCRONIZADO' %}Re-sincronizar este fornecedor{% elif fornecedor.status_sincronizacao_raw == 'ERRO' %}Tentar sincronizar novamente{% else %}Sincronizar este fornecedor com a API Fiscaut{% endif %}">
                                        
                                        <i data-feather="{% if fornecedor.status_sincronizacao_raw == 'SINCRONIZADO' %}check-circle{% elif fornecedor.status_sincronizacao_raw == 'ERRO' %}alert-triangle{% else %}refresh-cw{% endif %}" class="w-4 h-4 mr-1.5"></i>
                                        <span class="inline-block">
                                            {% if fornecedor.status_sincronizacao_raw == 'SINCRONIZADO' %}Sincronizado{% elif fornecedor.status_sincronizacao_raw == 'ERRO' %}Erro Sinc.{% else %}Sincronizar{% endif %}
                                        </span>
                                        <i data-feather="loader" class="animate-spin w-4 h-4 ml-1.5 hidden"></i>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            {# Paginação para Fornecedores #}
            {% if fornecedores_page_obj.paginator.num_pages > 1 %}
                <div class="mt-6 flex items-center justify-between">
                    <div class="text-sm text-gray-700">
                        Mostrando <span class="font-medium">{{ fornecedores_page_obj.start_index }}</span>
                        a <span class="font-medium">{{ fornecedores_page_obj.end_index }}</span>
                        de <span class="font-medium">{{ fornecedores_page_obj.paginator.count }}</span> resultados.
                    </div>
                    <div class="flex-1 flex justify-end">
                        <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Paginação">
                            {% if fornecedores_page_obj.has_previous %}
                                <a href="?f_page=1&f_codi_for={{ current_f_codi_for|default:'' }}&f_nome_for={{ current_f_nome_for|default:'' }}&f_cgce_for={{ current_f_cgce_for|default:'' }}"
                                   class="admin-pagination-btn rounded-l-md">
                                    <span class="sr-only">Primeira</span>
                                    <i data-feather="chevrons-left" class="h-5 w-5"></i>
                                </a>
                                <a href="?f_page={{ fornecedores_page_obj.previous_page_number }}&f_codi_for={{ current_f_codi_for|default:'' }}&f_nome_for={{ current_f_nome_for|default:'' }}&f_cgce_for={{ current_f_cgce_for|default:'' }}"
                                   class="admin-pagination-btn">
                                    <span class="sr-only">Anterior</span>
                                    <i data-feather="chevron-left" class="h-5 w-5"></i>
                                </a>
                            {% else %}
                                <span class="admin-pagination-btn-disabled rounded-l-md">
                                    <span class="sr-only">Primeira</span>
                                    <i data-feather="chevrons-left" class="h-5 w-5"></i>
                                </span>
                                <span class="admin-pagination-btn-disabled">
                                    <span class="sr-only">Anterior</span>
                                    <i data-feather="chevron-left" class="h-5 w-5"></i>
                                </span>
                            {% endif %}

                            {% for num in fornecedores_page_obj.paginator.page_range %}
                                {% if fornecedores_page_obj.number == num %}
                                    <span aria-current="page" class="admin-pagination-btn-active z-10">
                                        {{ num }}
                                    </span>
                                {% elif num > fornecedores_page_obj.number|add:'-3' and num < fornecedores_page_obj.number|add:'3' %}
                                    <a href="?f_page={{ num }}&f_codi_for={{ current_f_codi_for|default:'' }}&f_nome_for={{ current_f_nome_for|default:'' }}&f_cgce_for={{ current_f_cgce_for|default:'' }}"
                                       class="admin-pagination-btn">
                                        {{ num }}
                                    </a>
                                {% elif num == fornecedores_page_obj.paginator.page_range.0 or num == fornecedores_page_obj.paginator.page_range|last %}
                                    {# Adicionar '...' se houver grande salto de páginas, e sempre mostrar primeira/última se não estiverem no range próximo #}
                                    {% if num == fornecedores_page_obj.paginator.page_range.0 and fornecedores_page_obj.number|add:'-3' > fornecedores_page_obj.paginator.page_range.0 %}
                                        <span class="admin-pagination-btn-disabled">...</span>
                                    {% elif num == fornecedores_page_obj.paginator.page_range|last and fornecedores_page_obj.number|add:'3' < fornecedores_page_obj.paginator.page_range|last %}
                                        <span class="admin-pagination-btn-disabled">...</span>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}

                            {% if fornecedores_page_obj.has_next %}
                                <a href="?f_page={{ fornecedores_page_obj.next_page_number }}&f_codi_for={{ current_f_codi_for|default:'' }}&f_nome_for={{ current_f_nome_for|default:'' }}&f_cgce_for={{ current_f_cgce_for|default:'' }}"
                                   class="admin-pagination-btn">
                                    <span class="sr-only">Próxima</span>
                                    <i data-feather="chevron-right" class="h-5 w-5"></i>
                                </a>
                                <a href="?f_page={{ fornecedores_page_obj.paginator.num_pages }}&f_codi_for={{ current_f_codi_for|default:'' }}&f_nome_for={{ current_f_nome_for|default:'' }}&f_cgce_for={{ current_f_cgce_for|default:'' }}"
                                   class="admin-pagination-btn rounded-r-md">
                                    <span class="sr-only">Última</span>
                                    <i data-feather="chevrons-right" class="h-5 w-5"></i>
                                </a>
                            {% else %}
                                <span class="admin-pagination-btn-disabled">
                                    <span class="sr-only">Próxima</span>
                                    <i data-feather="chevron-right" class="h-5 w-5"></i>
                                </span>
                                <span class="admin-pagination-btn-disabled rounded-r-md">
                                    <span class="sr-only">Última</span>
                                    <i data-feather="chevrons-right" class="h-5 w-5"></i>
                                </span>
                            {% endif %}
                        </nav>
                    </div>
                </div>
            {% endif %}
        {% else %}
            <div class="text-center py-10">
                <i data-feather="info" class="w-12 h-12 mx-auto text-gray-400"></i>
                <p class="mt-2 text-sm text-gray-500">
                    Nenhum fornecedor encontrado para esta empresa{% if current_f_codi_for or current_f_nome_for or current_f_cgce_for %} com os filtros aplicados{% endif %}.
                </p>
            </div>
        {% endif %}
    </div>
    {# --- Fim da Seção de Fornecedores --- #}

</div>
{% endblock %}

{% block extra_js %}
<script>
    function empresaDetalhesPage(codiEmp, habilitadaInicial, cnpjEmpresa) {
        return {
            codiEmp: codiEmp,
            habilitada: habilitadaInicial,
            isLoadingToggle: false,
            isLoadingLote: false,
            cnpjEmpresa: cnpjEmpresa,

            getButtonClass(status) {
                if (status === 'SINCRONIZADO') {
                    return 'bg-green-600 hover:bg-green-700 text-white';
                } else if (status === 'ERRO') {
                    return 'bg-yellow-500 hover:bg-yellow-600 text-white';
                } else {
                    // Para "NAO_SINCRONIZADO" ou qualquer outro status
                    return 'bg-indigo-600 hover:bg-indigo-700 text-white';
                }
            },

            getCsrfToken() {
                let tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (tokenInput) return tokenInput.value; // Pega do form invisível, se houver
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith('csrftoken=')) {
                        return cookie.substring('csrftoken='.length, cookie.length);
                    }
                }
                // Adicionar um input CSRF se não existir para garantir que o token está disponível
                // (geralmente {% csrf_token %} no form principal da página já faria isso)
                // Se esta página não tiver um form com {% csrf_token %}, precisaremos buscar de outra forma ou garantir que `base.html` o inclua.
                // Como `sync_empresas_list` tem um form com csrf_token, e esta página extende `base.html`,
                // pode ser que o token já esteja em um cookie ou no DOM. A busca por cookie é uma boa alternativa.
                console.warn('CSRF token não encontrado diretamente no form. Tentando via cookie.');
                return null; 
            },

            async toggleSincronizacaoDetalhes() {
                this.isLoadingToggle = true;
                const novoStatus = !this.habilitada;
                const csrfToken = this.getCsrfToken();

                if (!csrfToken) {
                    console.error('CSRF token não encontrado para toggleSincronizacaoDetalhes!');
                    this.showMessageDetalhes('Erro de segurança (Token CSRF ausente). Tente recarregar a página.', 'error');
                    this.isLoadingToggle = false;
                    return;
                }

                try {
                    const response = await fetch(`{% url 'sync_api_toggle_empresa_sincronizacao' %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            codi_emp: this.codiEmp,
                            habilitar: novoStatus
                        })
                    });

                    const responseData = await response.json().catch(() => {
                        if (!response.ok) throw new Error(`Erro HTTP: ${response.status} - Resposta não JSON ou vazia.`);
                        return { success: response.ok }; 
                    });

                    if (!response.ok) {
                        throw new Error(responseData.message || `Erro HTTP: ${response.status}`);
                    }
                    
                    if (typeof responseData.success === 'undefined') {
                        responseData.success = response.ok;
                    }

                    if (responseData.success) {
                        this.habilitada = novoStatus;
                        this.showMessageDetalhes(responseData.message || 'Status de sincronização atualizado com sucesso!', 'success');
                    } else {
                        this.showMessageDetalhes(responseData.message || 'Erro ao atualizar o status de sincronização.', 'error');
                    }

                } catch (error) {
                    console.error('Erro ao tentar sincronizar empresa (detalhes):', error);
                    this.showMessageDetalhes(error.message || 'Erro de comunicação ao tentar atualizar o status.', 'error');
                } finally {
                    this.isLoadingToggle = false;
                    this.$nextTick(() => {
                        feather.replace(); // Para atualizar os ícones (loader, check-circle, slash)
                    });
                }
            },

            async chamarSincronizacaoFornecedor(event) {
                const button = event.currentTarget;
                const codiFor = button.dataset.codiFor;
                const nomeFor = button.dataset.nomeFor;
                const cgceFor = button.dataset.cgceFor;
                const codiCta = button.dataset.codiCta;

                // ... (lógica de UI: spinner, desabilitar botão)
                const iconLoading = button.querySelector('.animate-spin');
                const syncTextSpan = button.querySelector('span.inline-block'); // Selecionar o span do texto
                const originalButtonText = syncTextSpan.textContent;
                iconLoading.classList.remove('hidden');
                syncTextSpan.textContent = 'Sinc...';
                button.disabled = true;

                console.log(`DEBUG_JS_SINC_FORN: Iniciando sincronização. Empresa: ${this.codiEmp}, CNPJ Empresa: ${this.cnpjEmpresa}, Forn: ${codiFor}, Nome: ${nomeFor}`);
                const csrfToken = this.getCsrfToken();
                // ... (validações de CSRF e cnpjEmpresa)

                try {
                    const response = await fetch(`{% url 'sync_api_sincronizar_fornecedor_empresa' %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            cnpj_empresa: this.cnpjEmpresa,
                            codi_emp: this.codiEmp, // Este é o código numérico da empresa do sistema ODBC
                            codi_for: codiFor, // Este é o código do fornecedor do sistema ODBC
                            nome_fornecedor: nomeFor,
                            cnpj_fornecedor: cgceFor,
                            conta_contabil_fornecedor: codiCta
                        })
                    });

                    const responseData = await response.json().catch(() => {
                        console.error("DEBUG_JS_SINC_FORN: Resposta da API não é JSON.", response);
                        return { success: false, message: `Erro HTTP ${response.status} ao sincronizar. Resposta não JSON.` };
                    });
                    
                    console.log("DEBUG_JS_SINC_FORN: Resposta completa da API:", responseData);

                    if (responseData.success) {
                        this.showMessageDetalhes(responseData.message || 'Fornecedor sincronizado com sucesso!', 'success');
                        // ---- TENTATIVA DE ATUALIZAÇÃO DA UI ----
                        // Encontrar a linha da tabela e a célula de status para este fornecedor
                        const fornecedorRow = document.getElementById(`fornecedor-row-${codiFor}`);
                        if (fornecedorRow) {
                            console.log(`DEBUG_JS_SINC_FORN: Tentando atualizar UI para Forn ${codiFor}. Novo status esperado: Sincronizado`);
                            const statusCell = fornecedorRow.querySelector('td:nth-child(5) span'); // Assumindo que o status é o <span> na 5ª <td>
                            const statusTextCell = fornecedorRow.querySelector('td:nth-child(5) p.text-xs'); // Para data
                            if (statusCell) {
                                statusCell.textContent = 'Sincronizado'; // Texto direto
                                statusCell.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800'; // Classes para sucesso
                                console.log("DEBUG_JS_SINC_FORN: Célula de status atualizada para Sincronizado.");
                            }
                            if (statusTextCell) { // Atualizar data/hora
                                statusTextCell.textContent = new Date().toLocaleDateString('pt-BR') + ' ' + new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            }

                            // Atualizar botão
                            const buttonIcon = button.querySelector('i:not(.animate-spin)');
                            syncTextSpan.textContent = 'Sincronizado';
                            
                            // Aplicar classes do novo status
                            const allColorClasses = 'bg-indigo-600 hover:bg-indigo-700 bg-green-600 hover:bg-green-700 bg-yellow-500 hover:bg-yellow-600 text-white';
                            button.classList.remove(...allColorClasses.split(' '));
                            
                            // Adicionar classes para "SINCRONIZADO"
                            button.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
                            
                            if(buttonIcon) buttonIcon.dataset.feather = 'check-circle';
                            console.log("DEBUG_JS_SINC_FORN: Botão atualizado para Sincronizado.");
                        } else {
                            console.warn(`DEBUG_JS_SINC_FORN: Linha da tabela fornecedor-row-${codiFor} não encontrada para atualização da UI.`);
                        }
                    } else {
                        this.showMessageDetalhes(responseData.message || 'Falha ao sincronizar fornecedor.', 'error');
                        // Se falhou, não alteramos o status na UI, a menos que a API retorne um novo status de erro
                        // Poderíamos adicionar lógica para atualizar para 'Erro' se responseData.details.status_sincronizacao_raw indicar isso
                        console.log("DEBUG_JS_SINC_FORN: Sincronização falhou segundo a API. UI não alterada para sucesso.");
                    }

                } catch (error) {
                    console.error('Erro ao chamar sincronização de fornecedor:', error);
                    this.showMessageDetalhes(error.message || 'Erro de comunicação ao tentar sincronizar fornecedor.', 'error');
                } finally {
                    iconLoading.classList.add('hidden');
                    if (!responseData || !responseData.success) { // Restaurar texto original apenas se falhou
                         syncTextSpan.textContent = originalButtonText;
                         // Restaurar classes originais do botão se a API falhou. 
                         // As classes de :class no HTML devem cuidar de aplicar o estilo correto baseado no status_sincronizacao_raw que não mudou no front-end.
                         // Remover todas as classes de cor
                         const allColorClasses = 'bg-indigo-600 hover:bg-indigo-700 bg-green-600 hover:bg-green-700 bg-yellow-500 hover:bg-yellow-600 text-white';
                         button.classList.remove(...allColorClasses.split(' '));
                         
                         // Reabilitar o status original
                         const originalStatus = button.closest('tr').querySelector('td:nth-child(5) span').textContent.trim() === 'Sincronizado' ? 'SINCRONIZADO' : 
                                              (button.closest('tr').querySelector('td:nth-child(5) span').textContent.trim().includes('Erro') ? 'ERRO' : 'NAO_SINCRONIZADO');
                         
                         if (originalStatus === 'SINCRONIZADO') {
                             button.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
                         } else if (originalStatus === 'ERRO') {
                             button.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-white');
                         } else {
                             button.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'text-white');
                         }
                    }
                    button.disabled = false;
                    this.$nextTick(() => { feather.replace(); });
                }
            },

            async iniciarSincronizacaoEmLote() {
                if (!confirm("Tem certeza que deseja iniciar a sincronização em lote para os fornecedores pendentes desta empresa?")) {
                    return;
                }
                this.isLoadingLote = true;
                const csrfToken = this.getCsrfToken();

                if (!csrfToken) {
                    console.error('CSRF token não encontrado para iniciarSincronizacaoEmLote!');
                    this.showMessageDetalhes('Erro de segurança (Token CSRF ausente). Tente recarregar a página.', 'error');
                    this.isLoadingLote = false;
                    return;
                }

                try {
                    const response = await fetch(`{% url 'sync_api_sincronizar_fornecedores_lote' %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            codi_emp: this.codiEmp
                        })
                    });

                    const responseData = await response.json().catch(() => {
                        // Se a resposta não for JSON, mas o status for OK, pode ser um erro no backend que não retornou JSON esperado
                        if (!response.ok) throw new Error(`Erro HTTP: ${response.status} - Resposta não JSON ou vazia.`);
                        return { success: response.ok, message: "Resposta da API não era JSON, mas a requisição pode ter sido aceita." }; 
                    });

                    if (!response.ok && !responseData.message) { // Adiciona uma mensagem de erro genérica se não houver uma específica
                         responseData.message = `Falha ao iniciar sincronização em lote. Status: ${response.status}`;
                    }
                    
                    // Garante que responseData.success reflita o status da resposta HTTP se não definido explicitamente
                    if (typeof responseData.success === 'undefined') {
                        responseData.success = response.ok;
                    }

                    if (responseData.success) {
                        this.showMessageDetalhes(responseData.message || 'Sincronização em lote iniciada com sucesso. As atualizações aparecerão gradualmente.', 'success');
                    } else {
                        this.showMessageDetalhes(responseData.message || 'Falha ao iniciar a sincronização em lote.', 'error');
                    }

                } catch (error) {
                    console.error('Erro ao tentar iniciar sincronização em lote:', error);
                    this.showMessageDetalhes(error.message || 'Erro de comunicação ao tentar iniciar a sincronização em lote.', 'error');
                } finally {
                    this.isLoadingLote = false;
                    this.$nextTick(() => {
                        feather.replace(); // Para atualizar os ícones (loader)
                    });
                }
            },

            showMessageDetalhes(message, type = 'info') {
                const container = document.getElementById('message-container-detalhes');
                if (!container) {
                    console.warn("Elemento 'message-container-detalhes' não encontrado para exibir mensagem.");
                    return;
                }
                const messageId = `message-detalhes-${Date.now()}`;
                
                let bgColor, textColor, borderColor, icon;
                if (type === 'success') {
                    bgColor = 'bg-green-50'; textColor = 'text-green-700'; borderColor = 'border-green-200'; icon = 'check-circle';
                } else if (type === 'error') {
                    bgColor = 'bg-red-50'; textColor = 'text-red-700'; borderColor = 'border-red-200'; icon = 'alert-circle';
                } else if (type === 'warning') {
                    bgColor = 'bg-yellow-50'; textColor = 'text-yellow-700'; borderColor = 'border-yellow-200'; icon = 'alert-triangle';
                } else { // info
                    bgColor = 'bg-blue-50'; textColor = 'text-blue-700'; borderColor = 'border-blue-200'; icon = 'info';
                }

                const messageDiv = document.createElement('div');
                messageDiv.id = messageId;
                messageDiv.className = `p-3 rounded-md text-sm flex items-center shadow-lg ${bgColor} ${textColor} ${borderColor} border`;
                messageDiv.innerHTML = `
                    <i data-feather="${icon}" class="w-5 h-5 mr-2"></i>
                    <span>${message}</span>
                    <button onclick="
                        const elToRemove = document.getElementById('${messageId}');
                        if (elToRemove) elToRemove.remove();
                    " class="ml-auto -mx-1.5 -my-1.5 bg-transparent rounded-lg focus:ring-2 focus:ring-gray-400 p-1.5 hover:bg-gray-200 inline-flex h-8 w-8">
                        <span class="sr-only">Fechar</span>
                        <i data-feather="x" class="w-5 h-5"></i>
                    </button>
                `;
                container.appendChild(messageDiv);
                this.$nextTick(() => {
                    feather.replace(); 
                });

                setTimeout(() => {
                    const el = document.getElementById(messageId);
                    if (el) el.remove();
                }, 7000); // Aumentado para 7 segundos
            }
        };
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        // feather.replace(); // `base.html` já chama feather.replace() no DOMContentLoaded.
        // Se esta página adicionar ícones dinamicamente fora do escopo de Alpine que já chama feather.replace(),
        // pode ser necessário aqui, mas o Alpine já chama no `finally` do toggle e `showMessageDetalhes`.
    });
</script>
{% endblock %} 