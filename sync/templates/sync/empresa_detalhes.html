{% extends "sync/base.html" %}
{% load static %}

{% block title %}Detalhes da Empresa - {{ empresa.razao_emp|default:'Empresa' }}{% endblock %}

{% block page_title %}Detalhes da Empresa{% endblock %}
{% block page_subtitle %}{{ empresa.cgce_emp|default:'CNPJ não disponível' }}{% endblock %}

{% block content %}
<div class="admin-card space-y-6" x-data="empresaDetalhesPage({{ empresa.codi_emp|default:'null' }}, {{ empresa.habilitada_sincronizacao|yesno:'true,false,false' }}, '{{ empresa.cgce_emp|default:"" }}')">

    <!-- Botão Voltar e Título da Seção -->
    <div class="flex justify-between items-center mb-6">
        <div class="flex-1">
            <!-- O título principal da página já está no block page_title -->
            <!-- O subtítulo com CNPJ está no block page_subtitle -->
        </div>
        <a href="{% url 'sync_empresas_list' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-3 rounded-lg shadow-sm flex items-center whitespace-nowrap">
            <i data-feather="arrow-left" class="w-4 h-4 mr-2"></i>Voltar para Lista
        </a>
    </div>

    <!-- Informações da Empresa e Botão de Sincronização -->
    <div class="bg-white p-6 rounded-lg shadow border border-gray-200 space-y-4">
        <div class="flex justify-between items-start">
            <div>
                <h2 class="text-xl font-semibold text-gray-700">{{ empresa.razao_emp|default:'Nome não disponível' }}</h2>
                <p class="text-sm text-gray-500">CNPJ: {{ empresa.cgce_emp|default:'Não informado' }}</p>
            </div>
            <button @click="toggleSincronizacaoDetalhes()"
                    :class="{
                        'bg-green-600 hover:bg-green-700 text-white': habilitada,
                        'bg-red-600 hover:bg-red-700 text-white': !habilitada
                    }"
                    class="font-medium py-2 px-4 rounded-md shadow-sm whitespace-nowrap flex items-center">
                <i :data-feather="habilitada ? 'check-circle' : 'slash'" class="w-4 h-4 mr-2"></i>
                <span x-text="habilitada ? 'Sincronização Ativa' : 'Sincronização Inativa'"></span>
                <span x-show="isLoadingToggle" class="ml-2"><i data-feather="loader" class="animate-spin w-4 h-4"></i></span>
            </button>
        </div>

        <!-- Cards de Detalhes -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 pt-4">
            <div class="admin-info-card">
                <h3 class="text-sm font-medium text-gray-500">Código</h3>
                <p class="text-lg font-semibold text-gray-800">{{ empresa.codi_emp|default:'N/A' }}</p>
            </div>
            <div class="admin-info-card">
                <h3 class="text-sm font-medium text-gray-500">Razão Social</h3>
                <p class="text-lg font-semibold text-gray-800">{{ empresa.razao_emp|default:'N/A' }}</p>
            </div>
            <div class="admin-info-card">
                <h3 class="text-sm font-medium text-gray-500">CNPJ</h3>
                <p class="text-lg font-semibold text-gray-800">{{ empresa.cgce_emp|default:'N/A' }}</p>
            </div>
            <div class="admin-info-card border-l-4 w-max"
                 :class="{
                     'border-green-500': habilitada, 
                     'border-red-500': !habilitada,
                     'bg-green-50': habilitada,
                     'bg-red-50': !habilitada
                 }">
                <h3 class="text-sm font-medium text-gray-500">Status Sincronização</h3>
                <span :class="{'admin-badge-success': habilitada, 'admin-badge-danger': !habilitada}" class="px-3 py-1 rounded-full text-sm font-medium">
                    <span x-text="habilitada ? 'Ativa' : 'Inativa'"></span>
                </span>
            </div>
        </div>
    </div>

    <!-- Container para mensagens de notificação -->
    <div id="message-container-detalhes" class="fixed top-5 right-5 z-50 space-y-2"></div>

    <!-- Sistema de Abas -->
    <div x-data="{ activeTab: 'fornecedores' }" class="mt-8">
        <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button @click="activeTab = 'fornecedores'"
                        :class="activeTab === 'fornecedores' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Fornecedores
                </button>
                <button @click="activeTab = 'clientes'"
                        :class="activeTab === 'clientes' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Clientes
                </button>
                <button @click="activeTab = 'planos_contas'"
                        :class="activeTab === 'planos_contas' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Planos de Contas
                </button>
                <button @click="activeTab = 'acumuladores'"
                        :class="activeTab === 'acumuladores' ? 'border-indigo-500 text-indigo-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'"
                        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">
                    Acumuladores
                </button>
            </nav>
        </div>

        {# --- Seção de Fornecedores --- #}
        <div x-show="activeTab === 'fornecedores'" class="mt-6 pt-6 border-t border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Fornecedores da Empresa</h2>            
                <button @click="iniciarSincronizacaoEmLote()"
                        class="bg-red-600 hover:bg-red-700 text-white font-medium py-2 px-4 rounded-md shadow-sm flex items-center whitespace-nowrap"
                        title="Iniciar a sincronização em lote para fornecedores pendentes (status Não Sincronizado ou Erro) que possuem CNPJ.">
                    <i data-feather="zap" class="w-4 h-4 mr-2"></i>
                    Sincronizar todos os fornecedores
                    <span x-show="isLoadingLote" class="ml-2"><i data-feather="loader" class="animate-spin w-4 h-4"></i></span>
                </button>
            </div>

            <form method="GET" action="" class="mb-6 p-4 bg-gray-50 rounded-lg shadow">
                 <input type="hidden" name="tab" value="fornecedores"> {# Para manter a aba ativa após o GET #}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                    <div>
                        <label for="f_codi_for" class="block text-sm font-medium text-gray-700 mb-1">Cód. Fornecedor</label>
                        <input type="text" name="f_codi_for" id="f_codi_for" value="{{ current_f_codi_for|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm disabled:opacity-50 disabled:bg-gray-50">
                    </div>
                    <div>
                        <label for="f_nome_for" class="block text-sm font-medium text-gray-700 mb-1">Nome do Fornecedor</label>
                        <input type="text" name="f_nome_for" id="f_nome_for" value="{{ current_f_nome_for|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm disabled:opacity-50 disabled:bg-gray-50">
                    </div>
                    <div>
                        <label for="f_cgce_for" class="block text-sm font-medium text-gray-700 mb-1">CNPJ/CGC Fornecedor</label>
                        <input type="text" name="f_cgce_for" id="f_cgce_for" value="{{ current_f_cgce_for|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm disabled:opacity-50 disabled:bg-gray-50">
                    </div>
                    <div>
                        <label for="f_status_sinc" class="block text-sm font-medium text-gray-700 mb-1">Status Sincronização</label>
                        <select name="f_status_sinc" id="f_status_sinc" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm disabled:opacity-50 disabled:bg-gray-50">
                            <option value="todos" {% if current_f_status_sinc == 'todos' or not current_f_status_sinc %}selected{% endif %}>Todos</option>
                            <option value="NAO_SINCRONIZADO" {% if current_f_status_sinc == 'NAO_SINCRONIZADO' %}selected{% endif %}>Não Sincronizado</option>
                            <option value="SINCRONIZADO" {% if current_f_status_sinc == 'SINCRONIZADO' %}selected{% endif %}>Sincronizado</option>
                            <option value="ERRO" {% if current_f_status_sinc == 'ERRO' %}selected{% endif %}>Com Erro</option>
                        </select>
                    </div>
                    <div class="lg:col-span-4 flex space-x-2 justify-end">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm flex items-center w-full md:w-auto">
                            <i data-feather="filter" class="w-4 h-4 mr-2"></i>Filtrar
                        </button>
                        <a href="{% url 'sync_empresa_detalhes' codi_emp=empresa.codi_emp %}?tab=fornecedores" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md shadow-sm flex items-center w-full md:w-auto">
                            <i data-feather="rotate-ccw" class="w-4 h-4 mr-2"></i>Limpar
                        </a>
                    </div>
                </div>
            </form>

            {% if fornecedores_list %}
                <div class="overflow-x-auto admin-table-container rounded-lg shadow border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Cód. Forn.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">CNPJ/CGC</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Cód. Conta</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Status Sinc.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Ações</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                            {% for fornecedor in fornecedores_list %}
                                <tr id="fornecedor-row-{{ fornecedor.codi_for }}">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ fornecedor.codi_for }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ fornecedor.nome_for }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ fornecedor.cgce_for|default:'-' }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ fornecedor.codi_cta|default:'-' }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                              :class="{
                                                'bg-green-100 text-green-800': '{{ fornecedor.status_sincronizacao_raw }}' === 'SINCRONIZADO',
                                                'bg-red-100 text-red-800': '{{ fornecedor.status_sincronizacao_raw }}' === 'ERRO',
                                                'bg-gray-100 text-gray-800': '{{ fornecedor.status_sincronizacao_raw }}' !== 'SINCRONIZADO' && '{{ fornecedor.status_sincronizacao_raw }}' !== 'ERRO'
                                              }">
                                            {{ fornecedor.status_sincronizacao|default:'Não Sincronizado' }}
                                        </span>
                                        {% if fornecedor.ultima_tentativa_sinc %}
                                            <p class="text-xs text-gray-500 mt-1" title="Última tentativa de sincronização">
                                                {{ fornecedor.ultima_tentativa_sinc|date:"d/m/y H:i" }}
                                            </p>
                                        {% endif %}
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button @click="chamarSincronizacaoFornecedor($event)"
                                                data-codi-for="{{ fornecedor.codi_for }}"
                                                data-nome-for="{{ fornecedor.nome_for|escapejs }}"
                                                data-cgce-for="{{ fornecedor.cgce_for|default:'' }}"
                                                data-codi-cta="{{ fornecedor.codi_cta|default:'' }}"
                                                class="text-sm flex items-center justify-center px-3 py-1.5 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 font-semibold disabled:opacity-60 disabled:cursor-not-allowed transition-colors duration-200 {% if fornecedor.status_sincronizacao_raw == 'SINCRONIZADO' %}bg-green-600 hover:bg-green-700 text-white{% elif fornecedor.status_sincronizacao_raw == 'ERRO' %}bg-yellow-500 hover:bg-yellow-600 text-white{% else %}bg-indigo-600 hover:bg-indigo-700 text-white{% endif %}"
                                                title="{% if fornecedor.status_sincronizacao_raw == 'SINCRONIZADO' %}Re-sincronizar este fornecedor{% elif fornecedor.status_sincronizacao_raw == 'ERRO' %}Tentar sincronizar novamente{% else %}Sincronizar este fornecedor com a API Fiscaut{% endif %}">
                                            
                                            <i data-feather="{% if fornecedor.status_sincronizacao_raw == 'SINCRONIZADO' %}check-circle{% elif fornecedor.status_sincronizacao_raw == 'ERRO' %}alert-triangle{% else %}refresh-cw{% endif %}" class="w-4 h-4 mr-1.5"></i>
                                            <span class="inline-block">
                                                {% if fornecedor.status_sincronizacao_raw == 'SINCRONIZADO' %}Sincronizado{% elif fornecedor.status_sincronizacao_raw == 'ERRO' %}Erro Sinc.{% else %}Sincronizar{% endif %}
                                            </span>
                                            <i data-feather="loader" class="animate-spin w-4 h-4 ml-1.5 hidden"></i>
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% include "sync/partials/pagination_controls.html" with page_obj=fornecedores_page_obj param_prefix="f_" current_filters=request.GET %}
            {% else %}
                <div class="text-center py-10">
                    <i data-feather="info" class="w-12 h-12 mx-auto text-gray-400"></i>
                    <p class="mt-2 text-sm text-gray-500">
                        Nenhum fornecedor encontrado para esta empresa{% if current_f_codi_for or current_f_nome_for or current_f_cgce_for or current_f_status_sinc != 'todos' %} com os filtros aplicados{% endif %}.
                    </p>
                </div>
            {% endif %}
        </div>

        {# --- Seção de Clientes --- #}
        <div x-show="activeTab === 'clientes'" class="mt-6 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Clientes da Empresa</h2>
            
            <form method="GET" action="" class="mb-6 p-4 bg-gray-50 rounded-lg shadow">
                 <input type="hidden" name="tab" value="clientes">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="c_codi_cli" class="block text-sm font-medium text-gray-700 mb-1">Cód. Cliente</label>
                        <input type="text" name="c_codi_cli" id="c_codi_cli" value="{{ current_c_codi_cli|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="c_nome_cli" class="block text-sm font-medium text-gray-700 mb-1">Nome do Cliente</label>
                        <input type="text" name="c_nome_cli" id="c_nome_cli" value="{{ current_c_nome_cli|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="c_cgce_cli" class="block text-sm font-medium text-gray-700 mb-1">CNPJ/CGC Cliente</label>
                        <input type="text" name="c_cgce_cli" id="c_cgce_cli" value="{{ current_c_cgce_cli|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div class="lg:col-span-3 flex space-x-2 justify-end">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm flex items-center w-full md:w-auto">
                            <i data-feather="filter" class="w-4 h-4 mr-2"></i>Filtrar
                        </button>
                        <a href="{% url 'sync_empresa_detalhes' codi_emp=empresa.codi_emp %}?tab=clientes" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md shadow-sm flex items-center w-full md:w-auto">
                            <i data-feather="rotate-ccw" class="w-4 h-4 mr-2"></i>Limpar
                        </a>
                    </div>
                </div>
            </form>

            {% if clientes_list %}
                <div class="overflow-x-auto admin-table-container rounded-lg shadow border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Cód. Cli.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">CNPJ/CGC</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Cód. Conta</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                            {% for cliente in clientes_list %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ cliente.codi_cli }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ cliente.nome_cli }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ cliente.cgce_cli|default:'-' }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ cliente.codi_cta|default:'-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% include "sync/partials/pagination_controls.html" with page_obj=clientes_page_obj param_prefix="c_" current_filters=request.GET %}
            {% else %}
                <div class="text-center py-10">
                    <i data-feather="users" class="w-12 h-12 mx-auto text-gray-400"></i>
                    <p class="mt-2 text-sm text-gray-500">
                        Nenhum cliente encontrado para esta empresa{% if current_c_codi_cli or current_c_nome_cli or current_c_cgce_cli %} com os filtros aplicados{% endif %}.
                    </p>
                </div>
            {% endif %}
        </div>

        {# --- Seção de Planos de Contas --- #}
        <div x-show="activeTab === 'planos_contas'" class="mt-6 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Planos de Contas da Empresa</h2>

            <form method="GET" action="" class="mb-6 p-4 bg-gray-50 rounded-lg shadow">
                <input type="hidden" name="tab" value="planos_contas">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="pc_codi_cta" class="block text-sm font-medium text-gray-700 mb-1">Cód. Conta</label>
                        <input type="text" name="pc_codi_cta" id="pc_codi_cta" value="{{ current_pc_codi_cta|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="pc_nome_cta" class="block text-sm font-medium text-gray-700 mb-1">Nome da Conta</label>
                        <input type="text" name="pc_nome_cta" id="pc_nome_cta" value="{{ current_pc_nome_cta|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="pc_clas_cta" class="block text-sm font-medium text-gray-700 mb-1">Classificação</label>
                        <input type="text" name="pc_clas_cta" id="pc_clas_cta" value="{{ current_pc_clas_cta|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                     <div class="lg:col-span-3 flex space-x-2 justify-end">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm flex items-center w-full md:w-auto">
                            <i data-feather="filter" class="w-4 h-4 mr-2"></i>Filtrar
                        </button>
                        <a href="{% url 'sync_empresa_detalhes' codi_emp=empresa.codi_emp %}?tab=planos_contas" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md shadow-sm flex items-center w-full md:w-auto">
                            <i data-feather="rotate-ccw" class="w-4 h-4 mr-2"></i>Limpar
                        </a>
                    </div>
                </div>
            </form>

            {% if plano_contas_list %}
                <div class="overflow-x-auto admin-table-container rounded-lg shadow border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Cód. Conta</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Classificação</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Nome Conta</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Tipo</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                            {% for plano in plano_contas_list %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ plano.codi_cta }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ plano.clas_cta }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ plano.nome_cta }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ plano.tipo_cta|default:'-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% include "sync/partials/pagination_controls.html" with page_obj=plano_contas_page_obj param_prefix="pc_" current_filters=request.GET %}
            {% else %}
                <div class="text-center py-10">
                    <i data-feather="book-open" class="w-12 h-12 mx-auto text-gray-400"></i>
                    <p class="mt-2 text-sm text-gray-500">
                        Nenhum plano de contas encontrado para esta empresa{% if current_pc_codi_cta or current_pc_nome_cta or current_pc_clas_cta %} com os filtros aplicados{% endif %}.
                    </p>
                </div>
            {% endif %}
        </div>

        {# --- Seção de Acumuladores --- #}
        <div x-show="activeTab === 'acumuladores'" class="mt-6 pt-6 border-t border-gray-200">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Acumuladores da Empresa</h2>

            <form method="GET" action="" class="mb-6 p-4 bg-gray-50 rounded-lg shadow">
                <input type="hidden" name="tab" value="acumuladores">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="ac_codi_acu" class="block text-sm font-medium text-gray-700 mb-1">Cód. Acumulador</label>
                        <input type="text" name="ac_codi_acu" id="ac_codi_acu" value="{{ current_ac_codi_acu|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="ac_nome_acu" class="block text-sm font-medium text-gray-700 mb-1">Nome do Acumulador</label>
                        <input type="text" name="ac_nome_acu" id="ac_nome_acu" value="{{ current_ac_nome_acu|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="ac_descricao_acu" class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                        <input type="text" name="ac_descricao_acu" id="ac_descricao_acu" value="{{ current_ac_descricao_acu|default:'' }}" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                     <div class="lg:col-span-3 flex space-x-2 justify-end">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm flex items-center w-full md:w-auto">
                            <i data-feather="filter" class="w-4 h-4 mr-2"></i>Filtrar
                        </button>
                        <a href="{% url 'sync_empresa_detalhes' codi_emp=empresa.codi_emp %}?tab=acumuladores" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-md shadow-sm flex items-center w-full md:w-auto">
                            <i data-feather="rotate-ccw" class="w-4 h-4 mr-2"></i>Limpar
                        </a>
                    </div>
                </div>
            </form>

            {% if acumuladores_list %}
                <div class="overflow-x-auto admin-table-container rounded-lg shadow border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Cód. Acum.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Nome</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Descrição</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 bg-white">
                            {% for acumulador in acumuladores_list %}
                            <tr>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ acumulador.CODI_ACU }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ acumulador.NOME_ACU }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ acumulador.DESCRICAO_ACU|default:'-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% include "sync/partials/pagination_controls.html" with page_obj=acumuladores_page_obj param_prefix="ac_" current_filters=request.GET %}
            {% else %}
                <div class="text-center py-10">
                    <i data-feather="archive" class="w-12 h-12 mx-auto text-gray-400"></i>
                    <p class="mt-2 text-sm text-gray-500">
                        Nenhum acumulador encontrado para esta empresa{% if current_ac_codi_acu or current_ac_nome_acu or current_ac_descricao_acu %} com os filtros aplicados{% endif %}.
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function empresaDetalhesPage(codiEmp, habilitadaInicial, cnpjEmpresa) {
        return {
            codiEmp: codiEmp,
            habilitada: habilitadaInicial,
            isLoadingToggle: false,
            isLoadingLote: false,
            cnpjEmpresa: cnpjEmpresa,
            // activeTab é gerenciado pelo x-data no container das abas

            // Função para definir a aba ativa com base no parâmetro URL 'tab'
            initTabs() {
                const urlParams = new URLSearchParams(window.location.search);
                const tabParam = urlParams.get('tab');
                if (tabParam) {
                    this.$root.querySelector('[x-data*="activeTab"]').__x.$data.activeTab = tabParam;
                }
            },
            getButtonClass(status) {
                if (status === 'SINCRONIZADO') {
                    return 'bg-green-600 hover:bg-green-700 text-white';
                } else if (status === 'ERRO') {
                    return 'bg-yellow-500 hover:bg-yellow-600 text-white';
                } else {
                    return 'bg-indigo-600 hover:bg-indigo-700 text-white';
                }
            },

            getCsrfToken() {
                let tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
                if (tokenInput) return tokenInput.value;
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith('csrftoken=')) {
                        return cookie.substring('csrftoken='.length, cookie.length);
                    }
                }
                console.warn('CSRF token não encontrado.');
                return null; 
            },

            async toggleSincronizacaoDetalhes() {
                this.isLoadingToggle = true;
                const novoStatus = !this.habilitada;
                const csrfToken = this.getCsrfToken();

                if (!csrfToken) {
                    this.showMessageDetalhes('Erro de segurança (Token CSRF ausente). Tente recarregar a página.', 'error');
                    this.isLoadingToggle = false;
                    return;
                }

                try {
                    const response = await fetch(`{% url 'sync_api_toggle_empresa_sincronizacao' %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            codi_emp: this.codiEmp,
                            habilitar: novoStatus
                        })
                    });

                    const responseData = await response.json().catch(() => {
                        if (!response.ok) throw new Error(`Erro HTTP: ${response.status} - Resposta não JSON ou vazia.`);
                        return { success: response.ok }; 
                    });

                    if (!response.ok) {
                        throw new Error(responseData.message || `Erro HTTP: ${response.status}`);
                    }
                    
                    if (typeof responseData.success === 'undefined') {
                        responseData.success = response.ok;
                    }

                    if (responseData.success) {
                        this.habilitada = novoStatus;
                        this.showMessageDetalhes(responseData.message || 'Status de sincronização atualizado com sucesso!', 'success');
                    } else {
                        this.showMessageDetalhes(responseData.message || 'Erro ao atualizar o status de sincronização.', 'error');
                    }

                } catch (error) {
                    console.error('Erro ao tentar sincronizar empresa (detalhes):', error);
                    this.showMessageDetalhes(error.message || 'Erro de comunicação ao tentar atualizar o status.', 'error');
                } finally {
                    this.isLoadingToggle = false;
                    this.$nextTick(() => {
                        feather.replace(); 
                    });
                }
            },

            async chamarSincronizacaoFornecedor(event) {
                const button = event.currentTarget;
                const codiFor = button.dataset.codiFor;
                const nomeFor = button.dataset.nomeFor;
                const cgceFor = button.dataset.cgceFor;
                const codiCta = button.dataset.codiCta;

                const iconLoading = button.querySelector('i[data-feather="loader"]');
                const syncTextSpan = button.querySelector('span.inline-block');
                const originalButtonText = syncTextSpan.textContent;
                const mainIcon = button.querySelector('i:not([data-feather="loader"])');
                const originalIconClass = mainIcon.dataset.feather;

                iconLoading.classList.remove('hidden');
                syncTextSpan.textContent = 'Sinc...';
                mainIcon.classList.add('hidden');
                button.disabled = true;

                const csrfToken = this.getCsrfToken();
                if (!csrfToken || !this.cnpjEmpresa) {
                    this.showMessageDetalhes('Erro de configuração interna (CSRF ou CNPJ da empresa ausente).', 'error');
                    iconLoading.classList.add('hidden');
                    mainIcon.classList.remove('hidden');
                    syncTextSpan.textContent = originalButtonText;
                    button.disabled = false;
                    return;
                }
                let responseData = null; 
                try {
                    const response = await fetch(`{% url 'sync_api_sincronizar_fornecedor_empresa' %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            cnpj_empresa: this.cnpjEmpresa,
                            codi_emp: this.codiEmp,
                            codi_for: codiFor,
                            nome_fornecedor: nomeFor,
                            cnpj_fornecedor: cgceFor,
                            conta_contabil_fornecedor: codiCta
                        })
                    });

                    responseData = await response.json().catch(() => {
                        return { success: false, message: `Erro HTTP ${response.status} ao sincronizar. Resposta não JSON.` };
                    });
                    
                    if (responseData.success) {
                        this.showMessageDetalhes(responseData.message || 'Fornecedor sincronizado com sucesso!', 'success');
                        const fornecedorRow = document.getElementById(`fornecedor-row-${codiFor}`);
                        if (fornecedorRow) {
                            const statusCellSpan = fornecedorRow.querySelector('td:nth-child(5) span.rounded-full');
                            const statusCellDate = fornecedorRow.querySelector('td:nth-child(5) p.text-xs');
                            if (statusCellSpan) {
                                statusCellSpan.textContent = 'Sincronizado';
                                statusCellSpan.className = 'px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800';
                            }
                            if (statusCellDate) { 
                                statusCellDate.textContent = new Date().toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: '2-digit'}) + ' ' + new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            }
                            syncTextSpan.textContent = 'Sincronizado';
                            mainIcon.dataset.feather = 'check-circle';
                            button.className = button.className.replace(/bg-(indigo|yellow)-[0-9]+ hover:bg-(indigo|yellow)-[0-9]+/g, '') + ' bg-green-600 hover:bg-green-700';

                        }
                    } else {
                        this.showMessageDetalhes(responseData.message || 'Falha ao sincronizar fornecedor.', 'error');
                        syncTextSpan.textContent = 'Erro Sinc.';
                        mainIcon.dataset.feather = 'alert-triangle';
                        button.className = button.className.replace(/bg-(indigo|green)-[0-9]+ hover:bg-(indigo|green)-[0-9]+/g, '') + ' bg-yellow-500 hover:bg-yellow-600';

                    }

                } catch (error) {
                    this.showMessageDetalhes(error.message || 'Erro de comunicação ao tentar sincronizar fornecedor.', 'error');
                    syncTextSpan.textContent = originalButtonText;
                    mainIcon.dataset.feather = originalIconClass;
                } finally {
                    iconLoading.classList.add('hidden');
                    mainIcon.classList.remove('hidden');
                    button.disabled = false;
                    this.$nextTick(() => { feather.replace(); });
                }
            },

            async iniciarSincronizacaoEmLote() {
                if (!confirm("Tem certeza que deseja iniciar a sincronização em lote para os fornecedores pendentes desta empresa?")) {
                    return;
                }
                this.isLoadingLote = true;
                const csrfToken = this.getCsrfToken();

                if (!csrfToken) {
                    this.showMessageDetalhes('Erro de segurança (Token CSRF ausente). Tente recarregar a página.', 'error');
                    this.isLoadingLote = false;
                    return;
                }

                try {
                    const response = await fetch(`{% url 'sync_api_sincronizar_fornecedores_lote' %}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            codi_emp: this.codiEmp
                        })
                    });

                    const responseData = await response.json().catch(() => {
                        if (!response.ok) throw new Error(`Erro HTTP: ${response.status} - Resposta não JSON ou vazia.`);
                        return { success: response.ok, message: "Resposta da API não era JSON, mas a requisição pode ter sido aceita." }; 
                    });

                    if (!response.ok && !responseData.message) { 
                         responseData.message = `Falha ao iniciar sincronização em lote. Status: ${response.status}`;
                    }
                    
                    if (typeof responseData.success === 'undefined') {
                        responseData.success = response.ok;
                    }

                    if (responseData.success) {
                        this.showMessageDetalhes(responseData.message || 'Sincronização em lote iniciada com sucesso. As atualizações aparecerão gradualmente.', 'success');
                    } else {
                        this.showMessageDetalhes(responseData.message || 'Falha ao iniciar a sincronização em lote.', 'error');
                    }

                } catch (error) {
                    console.error('Erro ao tentar iniciar sincronização em lote:', error);
                    this.showMessageDetalhes(error.message || 'Erro de comunicação ao tentar iniciar a sincronização em lote.', 'error');
                } finally {
                    this.isLoadingLote = false;
                    this.$nextTick(() => {
                        feather.replace(); 
                    });
                }
            },

            showMessageDetalhes(message, type = 'info') {
                const container = document.getElementById('message-container-detalhes');
                if (!container) return;
                const messageId = `message-detalhes-${Date.now()}`;
                
                let bgColor, textColor, borderColor, icon;
                if (type === 'success') {
                    bgColor = 'bg-green-50'; textColor = 'text-green-700'; borderColor = 'border-green-200'; icon = 'check-circle';
                } else if (type === 'error') {
                    bgColor = 'bg-red-50'; textColor = 'text-red-700'; borderColor = 'border-red-200'; icon = 'alert-circle';
                } else if (type === 'warning') {
                    bgColor = 'bg-yellow-50'; textColor = 'text-yellow-700'; borderColor = 'border-yellow-200'; icon = 'alert-triangle';
                } else { 
                    bgColor = 'bg-blue-50'; textColor = 'text-blue-700'; borderColor = 'border-blue-200'; icon = 'info';
                }

                const messageDiv = document.createElement('div');
                messageDiv.id = messageId;
                messageDiv.className = `p-3 rounded-md text-sm flex items-center shadow-lg ${bgColor} ${textColor} ${borderColor} border`;
                messageDiv.innerHTML = `
                    <i data-feather="${icon}" class="w-5 h-5 mr-2"></i>
                    <span>${message}</span>
                    <button onclick="this.parentElement.remove()" class="ml-auto -mx-1.5 -my-1.5 bg-transparent rounded-lg focus:ring-2 focus:ring-gray-400 p-1.5 hover:bg-gray-200 inline-flex h-8 w-8">
                        <span class="sr-only">Fechar</span>
                        <i data-feather="x" class="w-5 h-5"></i>
                    </button>
                `;
                container.appendChild(messageDiv);
                this.$nextTick(() => { feather.replace(); });

                setTimeout(() => {
                    const el = document.getElementById(messageId);
                    if (el) el.remove();
                }, 7000);
            }
        };
    }
    document.addEventListener('DOMContentLoaded', () => {
        // Chama initTabs dentro do contexto AlpineJS após a inicialização
        const alpineContainer = document.querySelector('[x-data*="empresaDetalhesPage("]');
        if (alpineContainer && alpineContainer.__x) {
            alpineContainer.__x.initTabs();
        }
    });
</script>
{% endblock %} 