{% extends "sync/base.html" %}
{% load static %}

{% block title %}Configurações - Painel Administrativo{% endblock %}

{% block page_title %}Configurações{% endblock %}
{% block page_subtitle %}Gerenciamento das configurações do sistema{% endblock %}

{% block content %}
<div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
    <div class="lg:col-span-2">
        <!-- Configurações de Conexão ODBC -->
        <div class="mb-6 admin-card" x-data="odbcConnection()">
            <h3 class="mb-6 text-lg font-semibold text-gray-900">Configuração de Conexão ODBC</h3>
            
            <!-- Notificação de sucesso -->
            <div x-show="showNotification" x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-90"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-300"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-90"
                 class="flex items-center p-4 mb-4 rounded-lg"
                 :class="notificationType === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'">
                <i :data-feather="notificationType === 'success' ? 'check-circle' : 'alert-circle'" class="w-5 h-5 mr-2"></i>
                <span x-text="notificationMessage"></span>
                <button @click="showNotification = false" class="ml-auto hover:text-gray-900"
                        :class="notificationType === 'success' ? 'text-green-700' : 'text-red-700'">
                    <i data-feather="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <form class="space-y-4" @submit.prevent="saveConnection">
                <div>
                    <label for="dsn" class="admin-label">Nome da Fonte de Dados (DSN)</label>
                    <input type="text" id="dsn" class="admin-input" x-model="connection.dsn" required>
                </div>
                
                <div>
                    <label for="uid" class="admin-label">Usuário (UID)</label>
                    <input type="text" id="uid" class="admin-input" x-model="connection.uid" required>
                </div>
                
                <div>
                    <label for="pwd" class="admin-label">Senha (PWD)</label>
                    <div class="relative">
                        <input :type="showPassword ? 'text' : 'password'" id="pwd" class="pr-10 admin-input" 
                               x-model="connection.pwd" required>
                        <button type="button" @click="showPassword = !showPassword" 
                                class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700">
                            <i :data-feather="showPassword ? 'eye-off' : 'eye'" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label for="driver" class="admin-label">Driver (opcional)</label>
                    <input type="text" id="driver" class="admin-input" x-model="connection.driver" 
                           placeholder="Ex: {SQL Server}, {MySQL ODBC 8.0 Driver}">
                    <p class="mt-1 text-xs text-gray-500">Se não for especificado, o driver padrão do DSN será utilizado.</p>
                </div>
                
                <div class="flex flex-wrap gap-3 pt-4">
                    <button type="submit" class="admin-btn-primary" 
                            :disabled="isSaving"
                            :class="{'opacity-60 cursor-not-allowed': isSaving}">
                        <template x-if="!isSaving">
                            <i data-feather="save" class="w-4 h-4"></i>
                        </template>
                        <template x-if="isSaving">
                            <svg class="w-4 h-4 mr-2 -ml-1 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </template>
                        <span x-text="isSaving ? 'Salvando...' : 'Salvar Conexão'"></span>
                    </button>
                    
                    <button type="button" @click="testConnection" class="admin-btn-secondary" 
                            :disabled="isTesting || !connection.dsn || !connection.uid || !connection.pwd"
                            :class="{'opacity-60 cursor-not-allowed': isTesting || !connection.dsn || !connection.uid || !connection.pwd}">
                        <template x-if="!isTesting">
                            <i data-feather="activity" class="w-4 h-4"></i>
                        </template>
                        <template x-if="isTesting">
                            <svg class="w-4 h-4 mr-2 -ml-1 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </template>
                        <span x-text="isTesting ? 'Testando...' : 'Testar Conexão'"></span>
                    </button>
                </div>
            </form>
            
            <!-- Modal de detalhes da conexão -->
            <div x-show="showConnectionDetails" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0">
                <div class="w-full max-w-md p-6 mx-4 bg-white rounded-lg shadow-xl" 
                     @click.away="showConnectionDetails = false">
                    <h3 class="mb-4 text-lg font-medium text-gray-900">Detalhes da Conexão</h3>
                    
                    <div class="p-4 mb-4 overflow-auto text-sm rounded-lg bg-gray-50 max-h-80">
                        <div x-show="connectionStatus.success" class="flex items-center mb-3 text-emerald-600">
                            <i data-feather="check-circle" class="w-5 h-5 mr-2"></i>
                            <span class="font-semibold">Conexão estabelecida com sucesso!</span>
                        </div>
                        <div x-show="!connectionStatus.success" class="flex items-center mb-3 text-red-600">
                            <i data-feather="alert-circle" class="w-5 h-5 mr-2"></i>
                            <span class="font-semibold">Falha ao conectar</span>
                        </div>
                        
                        <div class="py-2 border-b border-gray-200">
                            <span class="font-medium">DSN:</span> <span x-text="connection.dsn"></span>
                        </div>
                        <div class="py-2 border-b border-gray-200">
                            <span class="font-medium">Usuário:</span> <span x-text="connection.uid"></span>
                        </div>
                        <div x-show="connection.driver" class="py-2 border-b border-gray-200">
                            <span class="font-medium">Driver:</span> <span x-text="connection.driver"></span>
                        </div>
                        <div x-show="connectionStatus.connection_string" class="py-2 border-b border-gray-200">
                            <span class="font-medium">String de Conexão:</span> <span x-text="connectionStatus.connection_string || 'N/A'"></span>
                        </div>
                        <div class="py-2 border-b border-gray-200">
                            <span class="font-medium">Versão do Driver:</span> <span x-text="connectionStatus.driver_version || 'N/A'"></span>
                        </div>
                        <div class="py-2 border-b border-gray-200">
                            <span class="font-medium">Versão do DBMS:</span> <span x-text="connectionStatus.dbms_version || 'N/A'"></span>
                        </div>
                        <div class="py-2" x-show="connectionStatus.databases && connectionStatus.databases.length > 0">
                            <span class="font-medium">Bancos de Dados Disponíveis:</span>
                            <ul class="pl-5 mt-1 list-disc">
                                <template x-for="db in connectionStatus.databases" :key="db">
                                    <li x-text="db"></li>
                                </template>
                            </ul>
                        </div>
                        
                        <!-- Detalhes de erro melhorados -->
                        <template x-if="!connectionStatus.success">
                            <div class="mt-3">
                                <div class="py-2 text-red-600 border-t border-gray-200">
                                    <span class="font-medium">Erro:</span> <span x-text="connectionStatus.error || 'Erro desconhecido'"></span>
                                </div>
                                
                                <!-- Sugestão baseada no tipo de erro -->
                                <div x-show="connectionStatus.error_details && connectionStatus.error_details.suggestion" 
                                    class="p-3 mt-2 bg-amber-50 border border-amber-200 rounded-md text-amber-800">
                                    <div class="flex items-center mb-1">
                                        <i data-feather="info" class="w-4 h-4 mr-2"></i>
                                        <span class="font-medium">Sugestão:</span>
                                    </div>
                                    <span x-text="connectionStatus.error_details.suggestion"></span>
                                </div>
                                
                                <!-- Detalhes técnicos do erro -->
                                <div x-show="connectionStatus.error_details" class="mt-3">
                                    <div class="flex items-center mb-1 cursor-pointer" @click="showTechnicalDetails = !showTechnicalDetails">
                                        <i :data-feather="showTechnicalDetails ? 'chevron-down' : 'chevron-right'" class="w-4 h-4 mr-1"></i>
                                        <span class="font-medium">Detalhes Técnicos</span>
                                    </div>
                                    
                                    <div x-show="showTechnicalDetails" class="p-2 mt-1 text-xs font-mono border border-gray-200 rounded-md bg-slate-50">
                                        <template x-if="connectionStatus.error_details.type">
                                            <div class="mb-1">
                                                <span class="font-medium">Tipo:</span> <span x-text="connectionStatus.error_details.type"></span>
                                            </div>
                                        </template>
                                        
                                        <template x-if="connectionStatus.error_details.specific_type">
                                            <div class="mb-1">
                                                <span class="font-medium">Subtipo:</span> <span x-text="connectionStatus.error_details.specific_type"></span>
                                            </div>
                                        </template>
                                        
                                        <template x-if="connectionStatus.error_details.code">
                                            <div class="mb-1">
                                                <span class="font-medium">Código:</span> <span x-text="connectionStatus.error_details.code"></span>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <div class="flex justify-end">
                        <button @click="showConnectionDetails = false" class="admin-btn-secondary">
                            Fechar
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Integrações -->
        <div class="admin-card" x-data="integrations()">
            <h3 class="mb-6 text-lg font-semibold text-gray-900">Integrações</h3>
            
            <div class="space-y-6">
                <div class="flex items-center justify-between pb-4 border-b border-gray-100">
                    <div class="flex items-center">
                        <div class="flex items-center justify-center w-10 h-10 mr-3 bg-blue-100 rounded-lg">
                            <i data-feather="database" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Sistema de Fiscalização</h4>
                            <p class="text-sm text-gray-500">Configuração da API principal</p>
                        </div>
                    </div>
                    <div>
                        <span :class="integrationStatus('fiscal').class" class="px-2 py-1 text-xs font-medium rounded-full">
                            <span x-text="integrationStatus('fiscal').text"></span>
                        </span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between pb-4 border-b border-gray-100">
                    <div class="flex items-center">
                        <div class="flex items-center justify-center w-10 h-10 mr-3 bg-purple-100 rounded-lg">
                            <i data-feather="mail" class="w-5 h-5 text-purple-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Servidor de Email</h4>
                            <p class="text-sm text-gray-500">Configuração do SMTP</p>
                        </div>
                    </div>
                    <div>
                        <span :class="integrationStatus('email').class" class="px-2 py-1 text-xs font-medium rounded-full">
                            <span x-text="integrationStatus('email').text"></span>
                        </span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex items-center justify-center w-10 h-10 mr-3 rounded-lg bg-amber-100">
                            <i data-feather="bell" class="w-5 h-5 text-amber-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Notificações Push</h4>
                            <p class="text-sm text-gray-500">Configuração das notificações</p>
                        </div>
                    </div>
                    <div>
                        <button @click="toggleIntegration('push')" class="px-2 py-1 text-xs font-medium rounded-full"
                               :class="integrationStatus('push').class">
                            <span x-text="integrationStatus('push').text"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Backup e Restauração -->
    <div>
        <div class="mb-6 admin-card" x-data="backupManager()">
            <h3 class="mb-4 text-lg font-semibold text-gray-900">Backup e Restauração</h3>
            <p class="mb-4 text-sm text-gray-500">Crie backups do sistema e restaure dados quando necessário.</p>
            
            <div class="space-y-3">
                <button @click="createBackup" class="justify-center w-full admin-btn-secondary"
                        :disabled="isCreatingBackup"
                        :class="{'opacity-60 cursor-not-allowed': isCreatingBackup}">
                    <template x-if="!isCreatingBackup">
                        <i data-feather="download" class="w-4 h-4"></i>
                    </template>
                    <template x-if="isCreatingBackup">
                        <svg class="w-4 h-4 mr-2 -ml-1 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </template>
                    <span x-text="isCreatingBackup ? 'Processando...' : 'Criar Backup Agora'"></span>
                </button>
                
                <button @click="openRestoreDialog" class="justify-center w-full admin-btn-secondary">
                    <i data-feather="upload" class="w-4 h-4"></i>
                    Restaurar Backup
                </button>
            </div>
            
            <div class="mt-6">
                <h4 class="mb-2 text-sm font-medium text-gray-700">Backups Automáticos</h4>
                <div class="flex items-center">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="autoBackup" class="sr-only peer" @change="toggleAutoBackup">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-700">Habilitado</span>
                    </label>
                </div>
            </div>
            
            <!-- Modal de restauração de backup (oculto por padrão) -->
            <div x-show="showRestoreModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0">
                <div class="w-full max-w-md p-6 bg-white rounded-lg shadow-xl" 
                     @click.away="showRestoreModal = false">
                    <h3 class="mb-4 text-lg font-medium text-gray-900">Restaurar Backup</h3>
                    <p class="mb-4 text-sm text-gray-600">
                        Selecione um arquivo de backup para restaurar. Isso substituirá os dados atuais!
                    </p>
                    <div class="mb-4">
                        <label class="justify-center w-full cursor-pointer admin-btn-secondary">
                            <i data-feather="file" class="w-4 h-4 mr-2"></i>
                            <span x-text="selectedFile ? selectedFile.name : 'Selecionar arquivo de backup'"></span>
                            <input type="file" class="hidden" @change="handleFileSelect">
                        </label>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button @click="showRestoreModal = false" class="admin-btn-secondary">
                            Cancelar
                        </button>
                        <button @click="restoreBackup" class="admin-btn-primary" 
                                :disabled="!selectedFile || isRestoring"
                                :class="{'opacity-60 cursor-not-allowed': !selectedFile || isRestoring}">
                            <span x-text="isRestoring ? 'Restaurando...' : 'Restaurar'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Limpeza de Dados -->
        <div class="admin-card" x-data="dataCleaner()">
            <h3 class="mb-4 text-lg font-semibold text-gray-900">Limpeza de Dados</h3>
            <p class="mb-4 text-sm text-gray-500">Limpe logs antigos e dados temporários para melhorar o desempenho.</p>
            
            <div class="space-y-4">
                <div>
                    <label for="log_retention" class="admin-label">Reter Logs Por</label>
                    <select id="log_retention" class="admin-input" x-model="logRetention" @change="updateLogRetention">
                        <option value="7">7 dias</option>
                        <option value="30">30 dias</option>
                        <option value="90">90 dias</option>
                        <option value="365">1 ano</option>
                    </select>
                </div>
                
                <div class="pt-2">
                    <button @click="cleanTempData" class="justify-center w-full admin-btn-secondary"
                            :disabled="isCleaning"
                            :class="{'opacity-60 cursor-not-allowed': isCleaning}">
                        <template x-if="!isCleaning">
                            <i data-feather="trash-2" class="w-4 h-4"></i>
                        </template>
                        <template x-if="isCleaning">
                            <svg class="w-4 h-4 mr-2 -ml-1 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </template>
                        <span x-text="isCleaning ? 'Limpando...' : 'Limpar Dados Temporários'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('alpine:init', () => {
        // Conexão ODBC
        Alpine.data('odbcConnection', () => ({
            connection: {
                dsn: '',
                uid: '',
                pwd: '',
                driver: ''
            },
            showPassword: false,
            showNotification: false,
            notificationType: 'success',
            notificationMessage: '',
            isSaving: false,
            isTesting: false,
            showConnectionDetails: false,
            showTechnicalDetails: false,
            connectionStatus: {
                success: false,
                driver_version: '',
                dbms_version: '',
                databases: [],
                error: '',
                error_details: {}
            },
            
            init() {
                // Carregar configurações salvas
                this.loadConnectionSettings();
            },
            
            async loadConnectionSettings() {
                try {
                    // Exibir indicador de carregamento
                    this.isSaving = true;
                    
                    // Obter configurações da API
                    const response = await fetch('{% url "sync_api_get_odbc_config" %}');
                    const data = await response.json();
                    
                    if (data.success && data.config) {
                        this.connection = {
                            dsn: data.config.dsn || '',
                            uid: data.config.uid || '',
                            pwd: '', // A senha real não é retornada pela API por segurança
                            driver: data.config.driver || ''
                        };
                    }
                } catch (error) {
                    console.error('Erro ao carregar configurações:', error);
                } finally {
                    this.isSaving = false;
                }
            },
            
            async saveConnection() {
                if (!this.connection.dsn || !this.connection.uid || !this.connection.pwd) {
                    this.showNotification = true;
                    this.notificationType = 'error';
                    this.notificationMessage = 'Preencha os campos obrigatórios: DSN, Usuário e Senha.';
                    return;
                }
                
                this.isSaving = true;
                
                try {
                    // Enviar configurações para a API
                    const response = await fetch('{% url "sync_api_save_odbc_config" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCSRFToken()
                        },
                        body: JSON.stringify(this.connection)
                    });
                    
                    const data = await response.json();
                    
                    this.showNotification = true;
                    
                    if (data.success) {
                        this.notificationType = 'success';
                        this.notificationMessage = 'Configurações de conexão ODBC salvas com sucesso!';
                    } else {
                        this.notificationType = 'error';
                        this.notificationMessage = data.message || 'Erro ao salvar configurações de conexão ODBC.';
                        console.error('Erro detalhado:', data);
                    }
                    
                    // Ocultar notificação após 5 segundos
                    setTimeout(() => {
                        this.showNotification = false;
                    }, 5000);
                } catch (error) {
                    console.error('Erro ao salvar conexão:', error);
                    this.showNotification = true;
                    this.notificationType = 'error';
                    this.notificationMessage = 'Erro ao salvar configurações de conexão ODBC.';
                } finally {
                    this.isSaving = false;
                    feather.replace();
                }
            },
            
            async testConnection() {
                if (!this.connection.dsn || !this.connection.uid || !this.connection.pwd) {
                    this.showNotification = true;
                    this.notificationType = 'error';
                    this.notificationMessage = 'Preencha os campos obrigatórios: DSN, Usuário e Senha.';
                    return;
                }
                
                this.isTesting = true;
                
                try {
                    // Testar conexão via API
                    const response = await fetch('{% url "sync_api_test_odbc_connection" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': this.getCSRFToken()
                        },
                        body: JSON.stringify({
                            use_saved: false,
                            dsn: this.connection.dsn,
                            uid: this.connection.uid,
                            pwd: this.connection.pwd,
                            driver: this.connection.driver
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.connectionStatus = data.result;
                        
                        this.showNotification = true;
                        this.notificationType = this.connectionStatus.success ? 'success' : 'error';
                        this.notificationMessage = this.connectionStatus.success 
                            ? 'Conexão ODBC estabelecida com sucesso!' 
                            : 'Falha ao conectar ao banco de dados ODBC.';
                        
                        // Mostrar detalhes da conexão
                        this.showConnectionDetails = true;
                    } else {
                        this.showNotification = true;
                        this.notificationType = 'error';
                        this.notificationMessage = data.message || 'Erro ao testar conexão ODBC.';
                    }
                    
                } catch (error) {
                    console.error('Erro ao testar conexão:', error);
                    this.connectionStatus = {
                        success: false,
                        driver_version: '',
                        dbms_version: '',
                        databases: [],
                        error: error.message || 'Erro desconhecido ao conectar'
                    };
                    
                    this.showNotification = true;
                    this.notificationType = 'error';
                    this.notificationMessage = 'Erro ao testar conexão ODBC.';
                } finally {
                    this.isTesting = false;
                    
                    // Atualizar ícones
                    setTimeout(() => {
                        feather.replace();
                    }, 50);
                }
            },
            
            // Função auxiliar para obter o token CSRF
            getCSRFToken() {
                const cookieValue = document.cookie
                    .split('; ')
                    .find(row => row.startsWith('csrftoken='))
                    ?.split('=')[1];
                return cookieValue || '';
            }
        }));
        
        // Integrações
        Alpine.data('integrations', () => ({
            integrations: {
                fiscal: true,  // Ativo
                email: true,   // Ativo
                push: false    // Inativo
            },
            
            integrationStatus(key) {
                if (this.integrations[key]) {
                    return {
                        text: 'Ativo',
                        class: 'bg-emerald-50 text-emerald-600'
                    };
                } else {
                    return {
                        text: 'Inativo',
                        class: 'bg-gray-50 text-gray-600'
                    };
                }
            },
            
            async toggleIntegration(key) {
                // Simulação de chamada à API
                await new Promise(resolve => setTimeout(resolve, 500));
                
                this.integrations[key] = !this.integrations[key];
                console.log(`Integração ${key} ${this.integrations[key] ? 'ativada' : 'desativada'}`);
                
                // Atualizar ícones
                feather.replace();
            }
        }));
        
        // Gerenciamento de Backup
        Alpine.data('backupManager', () => ({
            autoBackup: true,
            isCreatingBackup: false,
            showRestoreModal: false,
            selectedFile: null,
            isRestoring: false,
            
            async createBackup() {
                this.isCreatingBackup = true;
                
                try {
                    // Simulação de chamada à API
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    console.log('Backup criado com sucesso');
                    alert('Backup criado com sucesso!');
                } catch (error) {
                    console.error('Erro ao criar backup:', error);
                    alert('Erro ao criar backup. Tente novamente.');
                } finally {
                    this.isCreatingBackup = false;
                    feather.replace();
                }
            },
            
            toggleAutoBackup() {
                console.log('Backup automático:', this.autoBackup ? 'Ativado' : 'Desativado');
            },
            
            openRestoreDialog() {
                this.showRestoreModal = true;
                this.selectedFile = null;
                
                // Garantir que os ícones sejam renderizados no modal
                setTimeout(() => {
                    feather.replace();
                }, 100);
            },
            
            handleFileSelect(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    this.selectedFile = files[0];
                }
            },
            
            async restoreBackup() {
                if (!this.selectedFile) return;
                
                this.isRestoring = true;
                
                try {
                    // Simulação de upload e restauração
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    console.log('Backup restaurado:', this.selectedFile.name);
                    alert('Backup restaurado com sucesso!');
                    this.showRestoreModal = false;
                } catch (error) {
                    console.error('Erro na restauração:', error);
                    alert('Erro ao restaurar backup. Tente novamente.');
                } finally {
                    this.isRestoring = false;
                    feather.replace();
                }
            }
        }));
        
        // Limpeza de Dados
        Alpine.data('dataCleaner', () => ({
            logRetention: '30',
            isCleaning: false,
            
            updateLogRetention() {
                console.log('Período de retenção atualizado para', this.logRetention, 'dias');
            },
            
            async cleanTempData() {
                this.isCleaning = true;
                
                try {
                    // Simulação de chamada à API
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    console.log('Dados temporários limpos');
                    alert('Dados temporários limpos com sucesso!');
                } catch (error) {
                    console.error('Erro na limpeza:', error);
                    alert('Erro ao limpar dados. Tente novamente.');
                } finally {
                    this.isCleaning = false;
                    feather.replace();
                }
            }
        }));
    });
    
    // Garantir que ícones sejam renderizados após mudanças do Alpine
    document.addEventListener('alpine:initialized', () => {
        feather.replace();
    });
</script>
{% endblock %} 