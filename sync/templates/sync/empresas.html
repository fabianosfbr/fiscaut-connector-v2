{% extends "sync/base.html" %}
{% load static %}

{% block title %}Empresas - Painel Administrativo{% endblock %}

{% block page_title %}Listagem de Empresas{% endblock %}
{% block page_subtitle %}Consulta de empresas no Domínio Sistemas{% endblock %}

{% block content %}
<div class="admin-card space-y-6">
    
    <!-- Formulário de Filtros Modernizado -->
    <form method="get" action="{% url 'sync_empresas_list' %}" class="p-4 bg-gray-50 rounded-lg border border-gray-200">
        <div class="flex flex-wrap gap-4 items-end">
            <div class="flex-grow min-w-[150px]">
                <label for="codi_emp" class="admin-label">Cód. Empresa</label>
                <input type="number" name="codi_emp" id="codi_emp" value="{{ current_filters.codi_emp|default:'' }}" class="admin-input w-full">
            </div>
            <div class="flex-grow min-w-[200px]">
                <label for="cgce_emp" class="admin-label">CNPJ/CGC</label>
                <input type="text" name="cgce_emp" id="cgce_emp" value="{{ current_filters.cgce_emp|default:'' }}" class="admin-input w-full">
            </div>
            <div class="flex-grow min-w-[250px] flex-auto">
                <label for="razao_emp" class="admin-label">Razão Social</label>
                <input type="text" name="razao_emp" id="razao_emp" value="{{ current_filters.razao_emp|default:'' }}" class="admin-input w-full">
            </div>
            <div class="flex items-end space-x-2">
                <button type="submit" class="admin-btn-primary whitespace-nowrap">
                    <i data-feather="filter" class="w-4 h-4 mr-1 inline-block"></i>Filtrar
                </button>
                 <a href="{% url 'sync_empresas_list' %}" class="admin-btn-secondary whitespace-nowrap">
                    <i data-feather="rotate-ccw" class="w-4 h-4 mr-1 inline-block"></i>Limpar
                </a>
            </div>
        </div>
    </form>

    <!-- Tabela de Empresas -->
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg shadow overflow-hidden">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Cód. Empresa</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">CNPJ/CGC</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-600 uppercase tracking-wider">Razão Social</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for empresa in empresas_list %}
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ empresa.codi_emp }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ empresa.cgce_emp }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800">{{ empresa.razao_emp }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="3" class="px-6 py-10 text-center text-gray-500">
                            {% if current_filters.codi_emp or current_filters.cgce_emp or current_filters.razao_emp %}
                                Nenhuma empresa encontrada com os filtros aplicados.
                            {% else %}
                                Nenhuma empresa para exibir. Tente aplicar filtros ou verifique a conexão ODBC.
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Paginação e informações de resultado -->
    <div class="mt-4 flex flex-col md:flex-row justify-between items-center text-sm text-gray-600">
        {% if page_obj %}
            <div class="mb-2 md:mb-0">
                Mostrando 
                {% if page_obj.paginator.count > 0 %}
                    {% if page_obj.start_index == page_obj.end_index %}
                        registro {{ page_obj.start_index }}
                    {% else %}
                        registros {{ page_obj.start_index }} a {{ page_obj.end_index }}
                    {% endif %}
                    de {{ page_obj.paginator.count }}.
                {% else %}
                     0 registros de 0.
                {% endif %}
            </div>
            
            {% if page_obj.paginator.num_pages > 1 %}
            <nav aria-label="Paginação de empresas">
                <ul class="inline-flex items-center -space-x-px">
                    {% if page_obj.has_previous %}
                        <li>
                            <a href="?page=1&codi_emp={{ current_filters.codi_emp|default:'' }}&cgce_emp={{ current_filters.cgce_emp|default:'' }}&razao_emp={{ current_filters.razao_emp|default:'' }}" class="pagination-item rounded-l-md">
                                <span class="sr-only">Primeira</span>
                                <i data-feather="chevrons-left" class="w-4 h-4"></i>
                            </a>
                        </li>
                        <li>
                            <a href="?page={{ page_obj.previous_page_number }}&codi_emp={{ current_filters.codi_emp|default:'' }}&cgce_emp={{ current_filters.cgce_emp|default:'' }}&razao_emp={{ current_filters.razao_emp|default:'' }}" class="pagination-item">
                                <span class="sr-only">Anterior</span>
                                <i data-feather="chevron-left" class="w-4 h-4"></i>
                            </a>
                        </li>
                    {% else %}
                        <li>
                            <span class="pagination-item-disabled rounded-l-md">
                                <span class="sr-only">Primeira</span>
                                <i data-feather="chevrons-left" class="w-4 h-4"></i>
                            </span>
                        </li>
                        <li>
                            <span class="pagination-item-disabled">
                                <span class="sr-only">Anterior</span>
                                <i data-feather="chevron-left" class="w-4 h-4"></i>
                            </span>
                        </li>
                    {% endif %}

                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                            <li>
                                <span aria-current="page" class="pagination-item-active">{{ num }}</span>
                            </li>
                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li>
                                <a href="?page={{ num }}&codi_emp={{ current_filters.codi_emp|default:'' }}&cgce_emp={{ current_filters.cgce_emp|default:'' }}&razao_emp={{ current_filters.razao_emp|default:'' }}" class="pagination-item">{{ num }}</a>
                            </li>
                        {% elif num == page_obj.number|add:'-3' or num == page_obj.number|add:'3' %}
                            <li><span class="pagination-item-disabled">...</span></li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li>
                            <a href="?page={{ page_obj.next_page_number }}&codi_emp={{ current_filters.codi_emp|default:'' }}&cgce_emp={{ current_filters.cgce_emp|default:'' }}&razao_emp={{ current_filters.razao_emp|default:'' }}" class="pagination-item">
                                <span class="sr-only">Próxima</span>
                                <i data-feather="chevron-right" class="w-4 h-4"></i>
                            </a>
                        </li>
                        <li>
                            <a href="?page={{ page_obj.paginator.num_pages }}&codi_emp={{ current_filters.codi_emp|default:'' }}&cgce_emp={{ current_filters.cgce_emp|default:'' }}&razao_emp={{ current_filters.razao_emp|default:'' }}" class="pagination-item rounded-r-md">
                                <span class="sr-only">Última</span>
                                <i data-feather="chevrons-right" class="w-4 h-4"></i>
                            </a>
                        </li>
                    {% else %}
                        <li>
                            <span class="pagination-item-disabled">
                                <span class="sr-only">Próxima</span>
                                <i data-feather="chevron-right" class="w-4 h-4"></i>
                            </span>
                        </li>
                        <li>
                            <span class="pagination-item-disabled rounded-r-md">
                                <span class="sr-only">Última</span>
                                <i data-feather="chevrons-right" class="w-4 h-4"></i>
                            </span>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        {% elif total_records == 0 and not empresas_list %}
            <div class="mb-2 md:mb-0">Nenhum registro encontrado.</div>
        {% endif %}
    </div>

    <!-- Placeholder para mensagens de erro gerais (se houver) -->
    {% if messages %}
        <ul class="messages mt-4 space-y-2">
            {% for message in messages %}
                <li{% if message.tags %} class="p-3 rounded-md text-sm flex items-center {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}bg-red-50 text-red-700 border border-red-200{% elif message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}bg-green-50 text-green-700 border border-green-200{% elif message.level == DEFAULT_MESSAGE_LEVELS.WARNING %}bg-yellow-50 text-yellow-700 border border-yellow-200{% else %}bg-blue-50 text-blue-700 border border-blue-200{% endif %}"{% endif %}>
                    {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}<i data-feather="alert-circle" class="w-5 h-5 mr-2"></i>{% endif %}
                    {% if message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}<i data-feather="check-circle" class="w-5 h-5 mr-2"></i>{% endif %}
                    {% if message.level == DEFAULT_MESSAGE_LEVELS.WARNING %}<i data-feather="alert-triangle" class="w-5 h-5 mr-2"></i>{% endif %}
                    {% if message.level == DEFAULT_MESSAGE_LEVELS.INFO %}<i data-feather="info" class="w-5 h-5 mr-2"></i>{% endif %}
                    {{ message }}
                </li>
            {% endfor %}
        </ul>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
    // Script para reinicializar os ícones Feather após a renderização do template, se necessário.
    // Geralmente, o base.html já faz isso, mas se houver conteúdo carregado dinamicamente
    // ou interações do AlpineJS que adicionem ícones, pode ser útil.
    document.addEventListener('DOMContentLoaded', (event) => {
        feather.replace(); // Garante que os ícones sejam renderizados
    });

    // Se estiver usando AlpineJS para algo nesta página que adicione ícones dinamicamente,
    // você pode precisar chamar feather.replace() após essas operações do Alpine.
</script>
{% endblock %} 