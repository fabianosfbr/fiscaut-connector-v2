{% extends "admin/base.html" %}
{% load static %}

{% block title %}Configurações - Painel Administrativo{% endblock %}

{% block page_title %}Configurações{% endblock %}
{% block page_subtitle %}Gerenciamento das configurações do sistema{% endblock %}

{% block content %}
<div class="grid grid-cols-1 gap-6 lg:grid-cols-3">
    <div class="lg:col-span-2">
        <!-- Configurações Gerais -->
        <div class="mb-6 admin-card" x-data="generalSettings()">
            <h3 class="mb-6 text-lg font-semibold text-gray-900">Configurações Gerais</h3>
            
            <!-- Notificação de sucesso -->
            <div x-show="showNotification" x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 transform scale-90"
                 x-transition:enter-end="opacity-100 transform scale-100"
                 x-transition:leave="transition ease-in duration-300"
                 x-transition:leave-start="opacity-100 transform scale-100"
                 x-transition:leave-end="opacity-0 transform scale-90"
                 class="flex items-center p-4 mb-4 text-green-700 rounded-lg bg-green-50">
                <i data-feather="check-circle" class="w-5 h-5 mr-2"></i>
                <span>Configurações salvas com sucesso!</span>
                <button @click="showNotification = false" class="ml-auto text-green-700 hover:text-green-900">
                    <i data-feather="x" class="w-4 h-4"></i>
                </button>
            </div>
            
            <form class="space-y-4" @submit.prevent="saveSettings">
                <div>
                    <label for="site_name" class="admin-label">Nome do Sistema</label>
                    <input type="text" id="site_name" class="admin-input" x-model="settings.siteName">
                </div>
                
                <div>
                    <label for="admin_email" class="admin-label">Email do Administrador</label>
                    <input type="email" id="admin_email" class="admin-input" x-model="settings.adminEmail"
                           :class="{'border-red-300 focus:border-red-500 focus:ring-red-500': !isValidEmail}">
                    <p x-show="!isValidEmail" class="mt-1 text-sm text-red-600">Por favor, insira um email válido.</p>
                </div>
                
                <div>
                    <label for="timezone" class="admin-label">Fuso Horário</label>
                    <select id="timezone" class="admin-input" x-model="settings.timezone">
                        <option value="America/Sao_Paulo">America/Sao_Paulo</option>
                        <option value="America/Manaus">America/Manaus</option>
                        <option value="America/Fortaleza">America/Fortaleza</option>
                    </select>
                </div>
                
                <div>
                    <label class="admin-label">Modo de Manutenção</label>
                    <div class="flex items-center mt-2">
                        <label class="inline-flex items-center">
                            <input type="radio" name="maintenance_mode" value="0" 
                                  x-model="settings.maintenanceMode" class="text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-700">Desativado</span>
                        </label>
                        <label class="inline-flex items-center ml-6">
                            <input type="radio" name="maintenance_mode" value="1" 
                                  x-model="settings.maintenanceMode" class="text-indigo-600 focus:ring-indigo-500">
                            <span class="ml-2 text-sm text-gray-700">Ativado</span>
                        </label>
                    </div>
                </div>
                
                <div class="pt-4">
                    <button type="submit" class="admin-btn-primary" 
                            :disabled="!isValidEmail || isSaving"
                            :class="{'opacity-60 cursor-not-allowed': !isValidEmail || isSaving}">
                        <template x-if="!isSaving">
                            <i data-feather="save" class="w-4 h-4"></i>
                        </template>
                        <template x-if="isSaving">
                            <svg class="w-4 h-4 mr-2 -ml-1 text-white animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </template>
                        <span x-text="isSaving ? 'Salvando...' : 'Salvar Alterações'"></span>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Integrações -->
        <div class="admin-card" x-data="integrations()">
            <h3 class="mb-6 text-lg font-semibold text-gray-900">Integrações</h3>
            
            <div class="space-y-6">
                <div class="flex items-center justify-between pb-4 border-b border-gray-100">
                    <div class="flex items-center">
                        <div class="flex items-center justify-center w-10 h-10 mr-3 bg-blue-100 rounded-lg">
                            <i data-feather="database" class="w-5 h-5 text-blue-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Sistema de Fiscalização</h4>
                            <p class="text-sm text-gray-500">Configuração da API principal</p>
                        </div>
                    </div>
                    <div>
                        <span :class="integrationStatus('fiscal').class" class="px-2 py-1 text-xs font-medium rounded-full">
                            <span x-text="integrationStatus('fiscal').text"></span>
                        </span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between pb-4 border-b border-gray-100">
                    <div class="flex items-center">
                        <div class="flex items-center justify-center w-10 h-10 mr-3 bg-purple-100 rounded-lg">
                            <i data-feather="mail" class="w-5 h-5 text-purple-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Servidor de Email</h4>
                            <p class="text-sm text-gray-500">Configuração do SMTP</p>
                        </div>
                    </div>
                    <div>
                        <span :class="integrationStatus('email').class" class="px-2 py-1 text-xs font-medium rounded-full">
                            <span x-text="integrationStatus('email').text"></span>
                        </span>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex items-center justify-center w-10 h-10 mr-3 rounded-lg bg-amber-100">
                            <i data-feather="bell" class="w-5 h-5 text-amber-600"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">Notificações Push</h4>
                            <p class="text-sm text-gray-500">Configuração das notificações</p>
                        </div>
                    </div>
                    <div>
                        <button @click="toggleIntegration('push')" class="px-2 py-1 text-xs font-medium rounded-full"
                               :class="integrationStatus('push').class">
                            <span x-text="integrationStatus('push').text"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Backup e Restauração -->
    <div>
        <div class="mb-6 admin-card" x-data="backupManager()">
            <h3 class="mb-4 text-lg font-semibold text-gray-900">Backup e Restauração</h3>
            <p class="mb-4 text-sm text-gray-500">Crie backups do sistema e restaure dados quando necessário.</p>
            
            <div class="space-y-3">
                <button @click="createBackup" class="justify-center w-full admin-btn-secondary"
                        :disabled="isCreatingBackup"
                        :class="{'opacity-60 cursor-not-allowed': isCreatingBackup}">
                    <template x-if="!isCreatingBackup">
                        <i data-feather="download" class="w-4 h-4"></i>
                    </template>
                    <template x-if="isCreatingBackup">
                        <svg class="w-4 h-4 mr-2 -ml-1 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </template>
                    <span x-text="isCreatingBackup ? 'Processando...' : 'Criar Backup Agora'"></span>
                </button>
                
                <button @click="openRestoreDialog" class="justify-center w-full admin-btn-secondary">
                    <i data-feather="upload" class="w-4 h-4"></i>
                    Restaurar Backup
                </button>
            </div>
            
            <div class="mt-6">
                <h4 class="mb-2 text-sm font-medium text-gray-700">Backups Automáticos</h4>
                <div class="flex items-center">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" x-model="autoBackup" class="sr-only peer" @change="toggleAutoBackup">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                        <span class="ml-3 text-sm font-medium text-gray-700">Habilitado</span>
                    </label>
                </div>
            </div>
            
            <!-- Modal de restauração de backup (oculto por padrão) -->
            <div x-show="showRestoreModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0">
                <div class="w-full max-w-md p-6 bg-white rounded-lg shadow-xl" 
                     @click.away="showRestoreModal = false">
                    <h3 class="mb-4 text-lg font-medium text-gray-900">Restaurar Backup</h3>
                    <p class="mb-4 text-sm text-gray-600">
                        Selecione um arquivo de backup para restaurar. Isso substituirá os dados atuais!
                    </p>
                    <div class="mb-4">
                        <label class="justify-center w-full cursor-pointer admin-btn-secondary">
                            <i data-feather="file" class="w-4 h-4 mr-2"></i>
                            <span x-text="selectedFile ? selectedFile.name : 'Selecionar arquivo de backup'"></span>
                            <input type="file" class="hidden" @change="handleFileSelect">
                        </label>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button @click="showRestoreModal = false" class="admin-btn-secondary">
                            Cancelar
                        </button>
                        <button @click="restoreBackup" class="admin-btn-primary" 
                                :disabled="!selectedFile || isRestoring"
                                :class="{'opacity-60 cursor-not-allowed': !selectedFile || isRestoring}">
                            <span x-text="isRestoring ? 'Restaurando...' : 'Restaurar'"></span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Limpeza de Dados -->
        <div class="admin-card" x-data="dataCleaner()">
            <h3 class="mb-4 text-lg font-semibold text-gray-900">Limpeza de Dados</h3>
            <p class="mb-4 text-sm text-gray-500">Limpe logs antigos e dados temporários para melhorar o desempenho.</p>
            
            <div class="space-y-4">
                <div>
                    <label for="log_retention" class="admin-label">Reter Logs Por</label>
                    <select id="log_retention" class="admin-input" x-model="logRetention" @change="updateLogRetention">
                        <option value="7">7 dias</option>
                        <option value="30">30 dias</option>
                        <option value="90">90 dias</option>
                        <option value="365">1 ano</option>
                    </select>
                </div>
                
                <div class="pt-2">
                    <button @click="cleanTempData" class="justify-center w-full admin-btn-secondary"
                            :disabled="isCleaning"
                            :class="{'opacity-60 cursor-not-allowed': isCleaning}">
                        <template x-if="!isCleaning">
                            <i data-feather="trash-2" class="w-4 h-4"></i>
                        </template>
                        <template x-if="isCleaning">
                            <svg class="w-4 h-4 mr-2 -ml-1 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </template>
                        <span x-text="isCleaning ? 'Limpando...' : 'Limpar Dados Temporários'"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('alpine:init', () => {
        // Configurações Gerais
        Alpine.data('generalSettings', () => ({
            settings: {
                siteName: 'Fiscaut Connector',
                adminEmail: 'admin@fiscaut.com.br',
                timezone: 'America/Sao_Paulo',
                maintenanceMode: '0'
            },
            showNotification: false,
            isSaving: false,
            
            get isValidEmail() {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(this.settings.adminEmail);
            },
            
            async saveSettings() {
                if (!this.isValidEmail) return;
                
                this.isSaving = true;
                
                try {
                    // Simulação de chamada à API
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    console.log('Configurações salvas:', this.settings);
                    this.showNotification = true;
                    
                    // Ocultar notificação após 5 segundos
                    setTimeout(() => {
                        this.showNotification = false;
                    }, 5000);
                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    alert('Erro ao salvar as configurações. Tente novamente.');
                } finally {
                    this.isSaving = false;
                    feather.replace();
                }
            }
        }));
        
        // Integrações
        Alpine.data('integrations', () => ({
            integrations: {
                fiscal: true,  // Ativo
                email: true,   // Ativo
                push: false    // Inativo
            },
            
            integrationStatus(key) {
                if (this.integrations[key]) {
                    return {
                        text: 'Ativo',
                        class: 'bg-emerald-50 text-emerald-600'
                    };
                } else {
                    return {
                        text: 'Inativo',
                        class: 'bg-gray-50 text-gray-600'
                    };
                }
            },
            
            async toggleIntegration(key) {
                // Simulação de chamada à API
                await new Promise(resolve => setTimeout(resolve, 500));
                
                this.integrations[key] = !this.integrations[key];
                console.log(`Integração ${key} ${this.integrations[key] ? 'ativada' : 'desativada'}`);
                
                // Atualizar ícones
                feather.replace();
            }
        }));
        
        // Gerenciamento de Backup
        Alpine.data('backupManager', () => ({
            autoBackup: true,
            isCreatingBackup: false,
            showRestoreModal: false,
            selectedFile: null,
            isRestoring: false,
            
            async createBackup() {
                this.isCreatingBackup = true;
                
                try {
                    // Simulação de chamada à API
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    console.log('Backup criado com sucesso');
                    alert('Backup criado com sucesso!');
                } catch (error) {
                    console.error('Erro ao criar backup:', error);
                    alert('Erro ao criar backup. Tente novamente.');
                } finally {
                    this.isCreatingBackup = false;
                    feather.replace();
                }
            },
            
            toggleAutoBackup() {
                console.log('Backup automático:', this.autoBackup ? 'Ativado' : 'Desativado');
            },
            
            openRestoreDialog() {
                this.showRestoreModal = true;
                this.selectedFile = null;
                
                // Garantir que os ícones sejam renderizados no modal
                setTimeout(() => {
                    feather.replace();
                }, 100);
            },
            
            handleFileSelect(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    this.selectedFile = files[0];
                }
            },
            
            async restoreBackup() {
                if (!this.selectedFile) return;
                
                this.isRestoring = true;
                
                try {
                    // Simulação de upload e restauração
                    await new Promise(resolve => setTimeout(resolve, 3000));
                    
                    console.log('Backup restaurado:', this.selectedFile.name);
                    alert('Backup restaurado com sucesso!');
                    this.showRestoreModal = false;
                } catch (error) {
                    console.error('Erro na restauração:', error);
                    alert('Erro ao restaurar backup. Tente novamente.');
                } finally {
                    this.isRestoring = false;
                    feather.replace();
                }
            }
        }));
        
        // Limpeza de Dados
        Alpine.data('dataCleaner', () => ({
            logRetention: '30',
            isCleaning: false,
            
            updateLogRetention() {
                console.log('Período de retenção atualizado para', this.logRetention, 'dias');
            },
            
            async cleanTempData() {
                this.isCleaning = true;
                
                try {
                    // Simulação de chamada à API
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    console.log('Dados temporários limpos');
                    alert('Dados temporários limpos com sucesso!');
                } catch (error) {
                    console.error('Erro na limpeza:', error);
                    alert('Erro ao limpar dados. Tente novamente.');
                } finally {
                    this.isCleaning = false;
                    feather.replace();
                }
            }
        }));
    });
    
    // Garantir que ícones sejam renderizados após mudanças do Alpine
    document.addEventListener('alpine:initialized', () => {
        feather.replace();
    });
</script>
{% endblock %} 